From 3540b3f5e56446d07bff84ed0f1f9a6434e32ff3 Mon Sep 17 00:00:00 2001
From: Draycia <lonelyyordle@gmail.com>
Date: Tue, 14 Jan 2020 05:37:05 -0800
Subject: [PATCH] Use result of setItemStack in PlayerBucketEmptyEvent


diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 80219f2df..c8184f94e 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -1897,6 +1897,7 @@ public abstract class EntityLiving extends Entity {
         }
     }
 
+    public void setItemInHand(EnumHand enumhand, ItemStack itemstack) { this.a(enumhand, itemstack); } // Paper - OBFHELPER
     public void a(EnumHand enumhand, ItemStack itemstack) {
         if (enumhand == EnumHand.MAIN_HAND) {
             this.setSlot(EnumItemSlot.MAINHAND, itemstack);
diff --git a/src/main/java/net/minecraft/server/ItemBucket.java b/src/main/java/net/minecraft/server/ItemBucket.java
index 0ff92aea5..fe4a99917 100644
--- a/src/main/java/net/minecraft/server/ItemBucket.java
+++ b/src/main/java/net/minecraft/server/ItemBucket.java
@@ -140,6 +140,7 @@ public class ItemBucket extends Item {
                         ((EntityPlayer) entityhuman).getBukkitEntity().updateInventory(); // SPIGOT-4541
                         return false;
                     }
+                    itemstack = CraftItemStack.asNMSCopy(event.getItemStack()); // Paper - 2651: set item in hand if event isn't cancelled
                 }
                 // CraftBukkit end
                 if (world.worldProvider.isNether() && this.fluidType.a(TagsFluid.WATER)) {
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index c0fd2948e..4d07d3e89 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -377,7 +377,7 @@ public class CraftEventFactory {
     }
 
     public static PlayerBucketEmptyEvent callPlayerBucketEmptyEvent(World world, EntityHuman who, BlockPosition changed, BlockPosition clicked, EnumDirection clickedFace, ItemStack itemstack, EnumHand enumHand) {
-        return (PlayerBucketEmptyEvent) getPlayerBucketEvent(false, world, who, changed, clicked, clickedFace, itemstack, Items.BUCKET, enumHand);
+        return (PlayerBucketEmptyEvent) getPlayerBucketEvent(false, world, who, changed, clicked, clickedFace, itemstack, who.isCreative() ? itemstack.getItem() : Items.BUCKET, enumHand); // Paper - don't forcefully set to bucket
     }
 
     public static PlayerBucketFillEvent callPlayerBucketFillEvent(World world, EntityHuman who, BlockPosition changed, BlockPosition clicked, EnumDirection clickedFace, ItemStack itemInHand, net.minecraft.server.Item bucket, EnumHand enumHand) {
-- 
2.24.0

