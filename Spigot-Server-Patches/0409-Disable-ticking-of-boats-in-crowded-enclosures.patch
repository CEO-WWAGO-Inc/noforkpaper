From b1e77453ad5247342dad7d3b27ac048d32fb366c Mon Sep 17 00:00:00 2001
From: kickash32 <kickash32@gmail.com>
Date: Sun, 4 Aug 2019 15:19:46 +0500
Subject: [PATCH] Disable ticking of boats in crowded enclosures


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 318a470ee..9a93f27f4 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -562,4 +562,11 @@ public class PaperWorldConfig {
     private void disableRelativeProjectileVelocity() {
         disableRelativeProjectileVelocity = getBoolean("game-mechanics.disable-relative-projectile-velocity", false);
     }
+
+    public int minBoatCollisionsToDisableTicking;
+    public int disabledBoatTickingPeriod;
+    private void minBoatCollisionsToDisableTicking() {
+        minBoatCollisionsToDisableTicking = getInt("min-boat-collisions-to-disable-ticking", 10);
+        disabledBoatTickingPeriod = getInt("disabled-boat-ticking-period", 1000);
+    }
 }
diff --git a/src/main/java/net/minecraft/server/EntityBoat.java b/src/main/java/net/minecraft/server/EntityBoat.java
index 32b7f7805..37e7d8f60 100644
--- a/src/main/java/net/minecraft/server/EntityBoat.java
+++ b/src/main/java/net/minecraft/server/EntityBoat.java
@@ -53,6 +53,9 @@ public class EntityBoat extends Entity {
     public double unoccupiedDeceleration = -1;
     public boolean landBoats = false;
     // CraftBukkit end
+    // Paper start
+    private int machineActivatedTick = MinecraftServer.currentTick + 20;
+    // Paper end
 
     public EntityBoat(EntityTypes<? extends EntityBoat> entitytypes, World world) {
         super(entitytypes, world);
@@ -234,6 +237,17 @@ public class EntityBoat extends Entity {
     private Location lastLocation; // CraftBukkit
     @Override
     public void tick() {
+        // Paper start
+        boolean tickedAnyway = false;
+        if (machineActivatedTick < MinecraftServer.currentTick){
+            if ((MinecraftServer.currentTick + this.getId()) % this.world.paperConfig.disabledBoatTickingPeriod == 0 || this.isBurning() || !this.passengers.isEmpty() || this.getDamage() < 40F) {
+                tickedAnyway = true;
+            }
+            else {
+                return;
+            }
+        }
+        // Paper end
         this.aJ = this.aI;
         this.aI = this.s();
         if (this.aI != EntityBoat.EnumStatus.UNDER_WATER && this.aI != EntityBoat.EnumStatus.UNDER_FLOWING_WATER) {
@@ -313,14 +327,17 @@ public class EntityBoat extends Entity {
             }
         }
 
+
         this.checkBlockCollisions();
         List<Entity> list = this.world.getEntities(this, this.getBoundingBox().grow(0.20000000298023224D, -0.009999999776482582D, 0.20000000298023224D), IEntitySelector.a(this));
 
+        int boatCollisions = 0; // Paper
         if (!list.isEmpty()) {
             boolean flag = !this.world.isClientSide && !(this.getRidingPassenger() instanceof EntityHuman);
 
             for (int j = 0; j < list.size(); ++j) {
                 Entity entity = (Entity) list.get(j);
+                if (entity instanceof EntityBoat) { boatCollisions++; } // Paper
 
                 if (!entity.w(this)) {
                     if (flag && this.getPassengers().size() < 2 && !entity.isPassenger() && entity.getWidth() < this.getWidth() && entity instanceof EntityLiving && !(entity instanceof EntityWaterAnimal) && !(entity instanceof EntityHuman)) {
@@ -331,7 +348,11 @@ public class EntityBoat extends Entity {
                 }
             }
         }
-
+        // Paper start
+        if (boatCollisions < this.world.paperConfig.minBoatCollisionsToDisableTicking || tickedAnyway) {
+            this.machineActivatedTick = MinecraftServer.currentTick + 20;
+        }
+        // Paper end
     }
 
     private void q() {
-- 
2.22.0

