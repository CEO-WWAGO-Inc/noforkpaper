From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Tue, 18 May 2021 22:43:58 -0700
Subject: [PATCH] Add BlockDispenseEquipEvent

Implements SPIGOT-6023: https://hub.spigotmc.org/jira/browse/SPIGOT-6023

diff --git a/src/main/java/net/minecraft/core/dispenser/DispenseItemBehavior.java b/src/main/java/net/minecraft/core/dispenser/DispenseItemBehavior.java
index 92623ae25249d63efb92be8bd6c95228f9155ad2..4dab9d86aa3f94fdbd705545256068722f8eecef 100644
--- a/src/main/java/net/minecraft/core/dispenser/DispenseItemBehavior.java
+++ b/src/main/java/net/minecraft/core/dispenser/DispenseItemBehavior.java
@@ -321,6 +321,14 @@ public interface DispenseItemBehavior {
                 });
 
                 if (!list.isEmpty()) {
+                    // Paper start
+                    switch (org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockDispenseEquipEvent(pointer, stack, list.get(0))) {
+                        case PASSED:
+                            return stack;
+                        case CANCEL:
+                            return super.execute(pointer, stack);
+                    }
+                    // Paper end
                     ((Saddleable) list.get(0)).equipSaddle(SoundSource.BLOCKS);
                     stack.shrink(1);
                     this.setSuccess(true);
@@ -349,6 +357,14 @@ public interface DispenseItemBehavior {
                     entityhorseabstract = (AbstractHorse) iterator1.next();
                 } while (!entityhorseabstract.isArmor(stack) || entityhorseabstract.isWearingArmor() || !entityhorseabstract.isTamed());
 
+                // Paper start
+                switch (org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockDispenseEquipEvent(pointer, stack, entityhorseabstract)) {
+                    case PASSED:
+                        return stack;
+                    case CANCEL:
+                        return super.execute(pointer, stack);
+                }
+                // Paper end
                 entityhorseabstract.getSlot(401).set(stack.split(1));
                 this.setSuccess(true);
                 return stack;
@@ -392,6 +408,16 @@ public interface DispenseItemBehavior {
                     }
 
                     entityhorsechestedabstract = (AbstractChestedHorse) iterator1.next();
+                    // Paper start
+                    if (!entityhorsechestedabstract.hasChest() && entityhorsechestedabstract.isTamed()) { // Will succeed in equiping chest
+                        switch (org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockDispenseEquipEvent(pointer, stack, entityhorsechestedabstract)) {
+                            case PASSED:
+                                return stack;
+                            case CANCEL:
+                                return super.execute(pointer, stack);
+                        }
+                    }
+                    // Paper end
                 } while (!entityhorsechestedabstract.isTamed() || !entityhorsechestedabstract.getSlot(499).set(stack));
 
                 stack.shrink(1);
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 622a0f23db838b839f76722df0e5480ec927b4a2..8d2ea59530de25d5f78b4b7a58e9edca2f534b16 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -1858,5 +1858,29 @@ public class CraftEventFactory {
         io.papermc.paper.event.block.BlockPreDispenseEvent event = new io.papermc.paper.event.block.BlockPreDispenseEvent(block, org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemStack), slot);
         return event.callEvent();
     }
+
+    public static BlockDispenseEquipResult handleBlockDispenseEquipEvent(net.minecraft.core.BlockSource block, ItemStack dispensed, net.minecraft.world.entity.LivingEntity target) {
+        CraftItemStack item = CraftItemStack.asCraftMirror(dispensed);
+        io.papermc.paper.event.block.BlockDispenseEquipEvent event = new org.bukkit.event.block.BlockDispenseArmorEvent(CraftBlock.at(block.getLevel(), block.getPos()), item.clone(), target.getBukkitLivingEntity());
+        if (!net.minecraft.world.level.block.DispenserBlock.eventFired) {
+            event.callEvent();
+        }
+        if (event.isCancelled()) {
+            return BlockDispenseEquipResult.CANCEL;
+        } else if (!event.getItem().equals(item)) {
+            ItemStack eventStack = CraftItemStack.asNMSCopy(event.getItem());
+            net.minecraft.core.dispenser.DispenseItemBehavior idispensebehavior = (net.minecraft.core.dispenser.DispenseItemBehavior) net.minecraft.world.level.block.DispenserBlock.DISPENSER_REGISTRY.get(eventStack.getItem());
+            net.minecraft.world.level.block.DispenserBlock.eventFired = true;
+            idispensebehavior.dispense(block, eventStack);
+            return BlockDispenseEquipResult.PASSED;
+        }
+        return BlockDispenseEquipResult.ALLOW;
+    }
+
+    public enum BlockDispenseEquipResult {
+        PASSED,
+        CANCEL,
+        ALLOW
+    }
     // Paper end
 }
