From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Noah van der Aa <ndvdaa@gmail.com>
Date: Wed, 4 Aug 2021 20:12:02 +0200
Subject: [PATCH] Limit hopper transfer to max. stack size of container.


diff --git a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
index 3b1442bf4c83650369e925d76f07dc67c6cbbc83..8ea921d4592835559da23171b30e8c857ba0e418 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
@@ -589,9 +589,18 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
 
             if (itemstack1.isEmpty()) {
                 IGNORE_TILE_UPDATES = true; // Paper
-                to.setItem(slot, stack);
+                // Paper start
+                if (!stack.isEmpty() && stack.getCount() > to.getMaxStackSize()) {
+                    ItemStack itemstack2 = stack.copy();
+                    itemstack2.setCount(to.getMaxStackSize());
+                    to.setItem(slot, itemstack2);
+                    stack.shrink(to.getMaxStackSize());
+                } else {
+                    to.setItem(slot, stack);
+                    stack = ItemStack.EMPTY;
+                }
+                // Paper end
                 IGNORE_TILE_UPDATES = false; // Paper
-                stack = ItemStack.EMPTY;
                 flag = true;
             } else if (HopperBlockEntity.canMergeItems(itemstack1, stack)) {
                 int j = stack.getMaxStackSize() - itemstack1.getCount();
