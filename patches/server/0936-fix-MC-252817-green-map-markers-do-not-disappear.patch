From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: braindead <totsuka.sama@gmail.com>
Date: Sat, 5 Nov 2022 17:47:26 -0400
Subject: [PATCH] fix MC-252817 (green map markers do not disappear)


diff --git a/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java b/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
index d2a77b4ca343d19e1c70afe3f3906a9bd53d0eec..851ed990cc78ea4c3c8ed2d5aab33635d24bf836 100644
--- a/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
+++ b/src/main/java/net/minecraft/world/entity/decoration/ItemFrame.java
@@ -283,7 +283,11 @@ public class ItemFrame extends HangingEntity {
     }
 
     private void removeFramedMap(ItemStack itemstack) {
-        this.getFramedMapId().ifPresent((i) -> {
+        // Paper start - fix MC-252817 (green map markers do not dissappear)
+        // this bug is caused by the fact that the itemframe's item is set to empty before the green marker is requested to be removed
+        // this is fixed by getting the mapid from this method's parameter, rather than the air block now stored by the item frame.
+        this.getFramedMapIdFromItem(itemstack).ifPresent((i) -> {
+            // Paper end
             MapItemSavedData worldmap = MapItem.getSavedData(i, this.level);
 
             if (worldmap != null) {
@@ -301,9 +305,14 @@ public class ItemFrame extends HangingEntity {
 
     public OptionalInt getFramedMapId() {
         ItemStack itemstack = this.getItem();
+        // Paper start - fix MC-252817 (green map markers do not disappear)
+        return this.getFramedMapIdFromItem(itemstack);
+    }
 
-        if (itemstack.is(Items.FILLED_MAP)) {
-            Integer integer = MapItem.getMapId(itemstack);
+    public OptionalInt getFramedMapIdFromItem(ItemStack stack) {
+        // Paper end
+        if (stack.is(Items.FILLED_MAP)) {
+            Integer integer = MapItem.getMapId(stack);
 
             if (integer != null) {
                 return OptionalInt.of(integer);
