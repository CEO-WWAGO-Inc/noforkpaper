From 54dec4818215012d9751cf58e49eeb54b343a69f Mon Sep 17 00:00:00 2001
From: froobynooby <froobynooby@froobworld.com>
Date: Sat, 15 Feb 2020 22:58:58 +0930
Subject: [PATCH] Reduce entity tracker updates on move


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 15230a83..4bf6db8c 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -85,6 +85,10 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     public final int[] mobCounts = new int[ENUMCREATURETYPE_TOTAL_ENUMS]; // Paper
     public final com.destroystokyo.paper.util.PooledHashSets.PooledObjectLinkedOpenHashSet<EntityPlayer> cachedSingleMobDistanceMap;
     // Paper end
+    // Paper start - Reduce entity tracker updates on move
+    public Vec3D lastTrackedPosition = new Vec3D(0, 0, 0);
+    public long lastTrackedTick;
+    // Paper end
 
     // CraftBukkit start
     public String displayName;
diff --git a/src/main/java/net/minecraft/server/PlayerChunkMap.java b/src/main/java/net/minecraft/server/PlayerChunkMap.java
index 46d20538..c13452cc 100644
--- a/src/main/java/net/minecraft/server/PlayerChunkMap.java
+++ b/src/main/java/net/minecraft/server/PlayerChunkMap.java
@@ -1337,8 +1337,18 @@ public class PlayerChunkMap extends IChunkLoader implements PlayerChunk.d {
     public void movePlayer(EntityPlayer entityplayer) {
         ObjectIterator objectiterator = this.trackedEntities.values().iterator();
 
+        // Paper start - Reduce entity tracker updates on move
+        boolean fullUpdate = false;
+        if (MinecraftServer.currentTick - entityplayer.lastTrackedTick >= 20
+            || entityplayer.lastTrackedPosition.distanceSquared(entityplayer.getPositionVector()) >= 1) {
+            fullUpdate = true;
+            entityplayer.lastTrackedPosition = entityplayer.getPositionVector();
+            entityplayer.lastTrackedTick = MinecraftServer.currentTick;
+        }
+        // Paper end
         while (objectiterator.hasNext()) {
             PlayerChunkMap.EntityTracker playerchunkmap_entitytracker = (PlayerChunkMap.EntityTracker) objectiterator.next();
+            if (!fullUpdate && (playerchunkmap_entitytracker.trackedPlayers.isEmpty() || !playerchunkmap_entitytracker.trackedPlayers.contains(entityplayer))) continue; // Paper - Reduce entity tracker updates on move
 
             if (playerchunkmap_entitytracker.tracker == entityplayer) {
                 playerchunkmap_entitytracker.track(this.world.getPlayers());
-- 
2.24.1

