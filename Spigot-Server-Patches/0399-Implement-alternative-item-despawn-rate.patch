From 5782fc0ff56779a77b4a1025aaf1dfc8d97939a6 Mon Sep 17 00:00:00 2001
From: kickash32 <kickash32@gmail.com>
Date: Mon, 3 Jun 2019 02:02:39 -0400
Subject: [PATCH] Implement alternative item-despawn-rate


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index b8540619..d6c489e0 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -1,9 +1,15 @@
 package com.destroystokyo.paper;
 
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.HashSet;
 import java.util.List;
+import java.util.Set;
 
 import org.bukkit.Bukkit;
+import org.bukkit.Material;
 import org.bukkit.configuration.file.YamlConfiguration;
+import org.bukkit.entity.EntityType;
 import org.spigotmc.SpigotWorldConfig;
 
 import static com.destroystokyo.paper.PaperConfig.log;
@@ -109,6 +115,29 @@ public class PaperWorldConfig {
         hardDespawnDistance = hardDespawnDistance*hardDespawnDistance;
     }
 
+    public boolean altItemDespawnRateEnabled;
+    public Set<Material> altItemDespawnRateItems;
+    public int altItemDespawnRate;
+    private void altItemDespawnRate(){
+        altItemDespawnRateEnabled = getBoolean("alt-item-despawn-rate.enabled", false);
+        altItemDespawnRateItems = new HashSet<>();
+        for(String itemName : getList("alt-item-despawn-rate.items", Arrays.asList("COBBLESTONE","STONE","DIRT","SANDSNOWBALL","NETHERRACK"))){
+            try{
+                altItemDespawnRateItems.add(Material.getMaterial(itemName));
+            }
+            catch (Exception e){
+                logError("Could not add item " + itemName + " to altItemDespawnRateItems: " + e.getMessage());
+            }
+        }
+        altItemDespawnRate = getInt("alt-item-despawn-rate.removal-time", 1200);
+
+        if(altItemDespawnRateEnabled){
+            log("alt-item-despawn-rate: " + altItemDespawnRate);
+        }
+    }
+
     public boolean keepSpawnInMemory;
     private void keepSpawnInMemory() {
         keepSpawnInMemory = getBoolean("keep-spawn-loaded", true);
diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 7e925631..645fdd09 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -127,6 +127,18 @@ public class EntityItem extends Entity {
                 }
             }
 
+            // Paper start - alternative item despawn rate
+            if (world.paperConfig.altItemDespawnRateEnabled && world.paperConfig.altItemDespawnRateItems.contains(this.getItemStack().getBukkitStack().getType())) {
+                if(!this.world.isClientSide && this.age >= world.paperConfig.altItemDespawnRate) {
+                    if (org.bukkit.craftbukkit.event.CraftEventFactory.callItemDespawnEvent(this).isCancelled()) {
+                        this.age = 0;
+                        return;
+                    }
+                    this.die();
+                }
+                return;
+            }
+            // Paper end
             if (!this.world.isClientSide && this.age >= world.spigotConfig.itemDespawnRate) { // Spigot
                 // CraftBukkit start - fire ItemDespawnEvent
                 if (org.bukkit.craftbukkit.event.CraftEventFactory.callItemDespawnEvent(this).isCancelled()) {
-- 
2.19.0

