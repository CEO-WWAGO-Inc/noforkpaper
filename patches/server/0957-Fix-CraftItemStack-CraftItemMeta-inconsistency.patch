From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Auxilor <william.favierparsons1@gmail.com>
Date: Sun, 15 Jan 2023 19:09:56 +0000
Subject: [PATCH] Fixed legacy compatiblity for
 CraftItemStack#getEnchantmentLevel


diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
index 3e5abea2f814a0a364cf87ff4ce1b1718ba2ddac..d54cf4e68a7a6ed729bd5bb9de9ed5b87bd33464 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
@@ -1,14 +1,12 @@
 package org.bukkit.craftbukkit.inventory;
 
-import static org.bukkit.craftbukkit.inventory.CraftMetaItem.*;
 import com.google.common.collect.ImmutableMap;
-import java.util.Map;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.ListTag;
+import net.minecraft.resources.ResourceLocation;
 import net.minecraft.world.item.Item;
 import org.apache.commons.lang.Validate;
 import org.bukkit.Material;
-import org.bukkit.NamespacedKey;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 import org.bukkit.craftbukkit.enchantments.CraftEnchantment;
 import org.bukkit.craftbukkit.util.CraftLegacy;
@@ -19,6 +17,8 @@ import org.bukkit.inventory.ItemStack;
 import org.bukkit.inventory.meta.ItemMeta;
 import org.bukkit.material.MaterialData;
 
+import java.util.Map;
+
 @DelegateDeserialization(ItemStack.class)
 public final class CraftItemStack extends ItemStack {
 
@@ -214,7 +214,24 @@ public final class CraftItemStack extends ItemStack {
         if (this.handle == null) {
             return 0;
         }
-        return net.minecraft.world.item.enchantment.EnchantmentHelper.getItemEnchantmentLevel(CraftEnchantment.getRaw(ench), handle); // Paper
+
+        // Paper start
+        ListTag enchantments = this.handle.getEnchantmentTags();
+
+        for (int i = 0; i < enchantments.size(); i++) {
+            CompoundTag tag = enchantments.getCompound(i);
+
+            String id = tag.getString(CraftMetaItem.ENCHANTMENTS_ID.NBT);
+
+            Enchantment enchant = Enchantment.getByKey(CraftNamespacedKey.fromStringOrNull(id));
+
+            if (ench.equals(enchant)) {
+                return 0xffff & tag.getShort(CraftMetaItem.ENCHANTMENTS_LVL.NBT);
+            }
+        }
+
+        return 0;
+        // Paper end
     }
 
     @Override
@@ -249,8 +266,8 @@ public final class CraftItemStack extends ItemStack {
         ImmutableMap.Builder<Enchantment, Integer> result = ImmutableMap.builder();
 
         for (int i = 0; i < list.size(); i++) {
-            String id = ((CompoundTag) list.get(i)).getString(ENCHANTMENTS_ID.NBT);
-            int level = 0xffff & ((CompoundTag) list.get(i)).getShort(ENCHANTMENTS_LVL.NBT);
+            String id = ((CompoundTag) list.get(i)).getString(CraftMetaItem.ENCHANTMENTS_ID.NBT);
+            int level = 0xffff & ((CompoundTag) list.get(i)).getShort(CraftMetaItem.ENCHANTMENTS_LVL.NBT);
 
             Enchantment enchant = Enchantment.getByKey(CraftNamespacedKey.fromStringOrNull(id));
             if (enchant != null) {
@@ -278,6 +295,7 @@ public final class CraftItemStack extends ItemStack {
     public ItemMeta getItemMeta() {
         return CraftItemStack.getItemMeta(this.handle);
     }
+
     // Paper start
     public static void applyMetaToItem(net.minecraft.world.item.ItemStack itemStack, ItemMeta meta) {
         ((org.bukkit.craftbukkit.inventory.CraftMetaItem) meta).applyToItem(itemStack.getOrCreateTag());
@@ -286,6 +304,7 @@ public final class CraftItemStack extends ItemStack {
     public static ItemMeta getItemMeta(net.minecraft.world.item.ItemStack item) {
         return getItemMeta(item, CraftItemStack.getType(item));
     }
+
     public static ItemMeta getItemMeta(net.minecraft.world.item.ItemStack item, Material material) {
         // Paper end
         if (!CraftItemStack.hasItemMeta(item)) {

