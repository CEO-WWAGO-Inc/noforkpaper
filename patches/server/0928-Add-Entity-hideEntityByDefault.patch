From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: zJanny <jan.trummer@hotmail.com>
Date: Sat, 30 Jul 2022 19:37:48 +0200
Subject: [PATCH] Add Entity#hideEntityByDefault


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index f925a8d550ecbf2044a37bfe58b30d6578c5f6af..1331aeb818790d20028a72bfac012b14fb1667df 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -160,6 +160,7 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
     // CraftBukkit start
     private static final int CURRENT_LEVEL = 2;
     public boolean preserveMotion = true; // Paper - keep initial motion on first setPositionRotation
+    private boolean isHiddenByDefault = false; // Paper
     static boolean isLevelAtLeast(CompoundTag tag, int level) {
         return tag.contains("Bukkit.updateLevel") && tag.getInt("Bukkit.updateLevel") >= level;
     }
@@ -3686,7 +3687,7 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
     }
 
     public boolean broadcastToPlayer(ServerPlayer spectator) {
-        return true;
+        return !this.getIsHiddenByDefault(); // Paper
     }
 
     @Override
@@ -4431,4 +4432,15 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
         return ((ServerChunkCache) level.getChunkSource()).isPositionTicking(this);
     }
     // Paper end
+
+    // Paper start
+    public void setHideEntityByDefault(boolean hide){
+        this.setSilent(hide);
+        this.isHiddenByDefault = hide;
+    }
+
+    public boolean getIsHiddenByDefault(){
+        return this.isHiddenByDefault;
+    }
+    // Paper end
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index b80cc0938b2b3928f4450f1314a9fbd7ea9c116b..37029acb7e3f838c5522439b1620cc2750aa66b5 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -1339,5 +1339,15 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
     public boolean isInPowderedSnow() {
         return getHandle().isInPowderSnow || getHandle().wasInPowderSnow; // depending on the location in the entity "tick" either could be needed.
     }
+
+    @Override
+    public boolean getIsHiddenByDefault(){
+        return getHandle().getIsHiddenByDefault();
+    }
+
+    @Override
+    public void setHideEntityByDefault(boolean hide){
+        getHandle().setHideEntityByDefault(hide);
+    }
     // Paper end
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index ef9c3a7b15a4901e1662e6d55504b9cbbb804ad3..8d6897e8da84422c49e51af30c7569f71cebbb71 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1843,7 +1843,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     @Override
     public boolean canSee(org.bukkit.entity.Entity entity) {
-        return !this.hiddenEntities.containsKey(entity.getUniqueId());
+        return !this.hiddenEntities.containsKey(entity.getUniqueId()) && !entity.getIsHiddenByDefault(); // Paper
     }
 
     @Override
