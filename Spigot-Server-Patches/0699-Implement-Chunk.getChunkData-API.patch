From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Paul Sauve <paul@technove.co>
Date: Tue, 16 Mar 2021 02:24:44 -0500
Subject: [PATCH] Implement Chunk.getChunkData API


diff --git a/src/main/java/net/minecraft/world/level/chunk/DataPaletteBlock.java b/src/main/java/net/minecraft/world/level/chunk/DataPaletteBlock.java
index 86dfab740883c138a0df8a3da9dfb4eb9acefaa3..30cde171d154812057b18b3b285cddfb0da45336 100644
--- a/src/main/java/net/minecraft/world/level/chunk/DataPaletteBlock.java
+++ b/src/main/java/net/minecraft/world/level/chunk/DataPaletteBlock.java
@@ -168,6 +168,7 @@ public class DataPaletteBlock<T> implements DataPaletteExpandable<T> {
         this.a.b(i, j);
     }
 
+    public T getBlockAt(int x, int y, int z) { return this.a(x, y, z); } // Paper - OBFHELPER
     public T a(int i, int j, int k) {
         return this.a(j << 8 | k << 4 | i); // Paper - inline
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java
index 98ab124b4dca9387b4793cef68a33c67aed64e21..1ec51a448dadb6841f015b04595920be11e78501 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java
@@ -263,6 +263,41 @@ public class CraftChunk implements Chunk {
         return false;
     }
 
+    // Paper start
+    @Override
+    public org.bukkit.Material[] getBlockArray(org.bukkit.Material[] array) {
+        int size = 16 * 16 * this.getWorld().getMaxHeight();
+        if (array.length != size) {
+            array = new org.bukkit.Material[size];
+        } else {
+            Arrays.fill(array, null);
+        }
+
+        net.minecraft.world.level.chunk.Chunk chunk = getHandle();
+
+        ChunkSection[] cs = chunk.getSections();
+
+        int index = 0;
+        for (int i = 0; i < cs.length; i++) {
+            if (cs[i] == null) {
+                index += 16 * 16 * 16;
+            } else {
+                DataPaletteBlock<IBlockData> blocks = cs[i].getBlocks();
+
+                for (int y = 0; y < 16; y++) {
+                    for (int z = 0; z < 16; z++) {
+                        for (int x = 0; x < 16; x++) {
+                            array[index++] = blocks.getBlockAt(x, y, z).getBukkitMaterial();
+                        }
+                    }
+                }
+            }
+        }
+
+        return array;
+    }
+    // Paper end
+
     @Override
     public ChunkSnapshot getChunkSnapshot() {
         return getChunkSnapshot(true, false, false);
