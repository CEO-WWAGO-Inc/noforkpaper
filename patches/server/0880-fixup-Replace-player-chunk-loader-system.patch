From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Fri, 18 Feb 2022 08:20:00 -0800
Subject: [PATCH] fixup! Replace player chunk loader system


diff --git a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
index 6d4f5ab1bcc166b926c67dc9613f326c3fc7e544..928740812f419469725d598cd54a129835f6a311 100644
--- a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
+++ b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
@@ -834,7 +834,7 @@ public final class PlayerChunkLoader {
         }
 
         public void setTargetTickViewDistance(final int distance) {
-            if (distance < MIN_VIEW_DISTANCE || distance > MAX_VIEW_DISTANCE) {
+            if (distance != -1 && (distance < MIN_VIEW_DISTANCE || distance > MAX_VIEW_DISTANCE)) {
                 throw new IllegalArgumentException(Integer.toString(distance));
             }
             this.tickViewDistance = distance;
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index dfd32e1213056ed1061f647c95fd71bfbab41294..2c3ce2065812de227c34506edddb439da9a07ba1 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -2234,6 +2234,18 @@ public class CraftWorld extends CraftRegionAccessor implements World {
         // Paper end - replace old player chunk management
     }
 
+    // Paper start - replace old player chunk management
+    @Override
+    public void setSimulationDistance(int simulationDistance) {
+        // Paper start - replace old player chunk management
+        if (simulationDistance < 2 || simulationDistance > 32) {
+            throw new IllegalArgumentException("Simulation distance " + simulationDistance + " is out of range of [2, 32]");
+        }
+        net.minecraft.server.level.ChunkMap chunkMap = getHandle().getChunkSource().chunkMap;
+        chunkMap.setTickViewDistance(simulationDistance);
+    }
+    // Paper end - replace old player chunk management
+
     @Override
     public int getNoTickViewDistance() {
         return this.getViewDistance(); // Paper - replace old player chunk management
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 2088b708d7ed7af8de0df31493084d8fcfed8a70..ef841a5ea1f634e87e5437faf83dc00efd590106 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -580,6 +580,27 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
         data.setTargetNoTickViewDistance(viewDistance);
     }
+
+    @Override
+    public int getSimulationDistance() {
+        net.minecraft.server.level.ChunkMap chunkMap = this.getHandle().getLevel().getChunkSource().chunkMap;
+        io.papermc.paper.chunk.PlayerChunkLoader.PlayerLoaderData data = chunkMap.playerChunkManager.getData(this.getHandle());
+        if (data == null) {
+            return chunkMap.playerChunkManager.getTargetTickViewDistance();
+        }
+        return data.getTargetTickViewDistance();
+    }
+
+    @Override
+    public void setSimulationDistance(int simulationDistance) {
+        net.minecraft.server.level.ChunkMap chunkMap = this.getHandle().getLevel().getChunkSource().chunkMap;
+        io.papermc.paper.chunk.PlayerChunkLoader.PlayerLoaderData data = chunkMap.playerChunkManager.getData(this.getHandle());
+        if (data == null) {
+            throw new IllegalStateException("Player is not attached to world");
+        }
+
+        data.setTargetTickViewDistance(simulationDistance);
+    }
     // Paper end - implement view distances
 
     @Override
