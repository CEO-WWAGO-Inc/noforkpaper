From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Daniel Schmerber <danielschhhm@gmail.com>
Date: Wed, 31 Jan 2024 11:46:43 +0100
Subject: [PATCH] fix collision edge case


diff --git a/src/main/java/io/papermc/paper/util/CollisionUtil.java b/src/main/java/io/papermc/paper/util/CollisionUtil.java
index ee0331a6bc40cdde08d926fd8eb1dc642630c2e5..9c11328a3d2711b56b098ef7147c324f90adfac7 100644
--- a/src/main/java/io/papermc/paper/util/CollisionUtil.java
+++ b/src/main/java/io/papermc/paper/util/CollisionUtil.java
@@ -86,6 +86,13 @@ public final class CollisionUtil {
                (box.minZ - maxZ) < -COLLISION_EPSILON && (box.maxZ - minZ) > COLLISION_EPSILON;
     }
 
+    public static boolean voxelShapeIntersectWithOutEpsilon(final AABB box, final double minX, final double minY, final double minZ,
+                                              final double maxX, final double maxY, final double maxZ) {
+        return  box.minX < maxX && box.maxX > minX &&
+                box.minY < maxY && box.maxY > minY &&
+                box.minZ < maxZ && box.maxZ > minZ;
+    }
+
     public static boolean voxelShapeIntersect(final AABB box1, final AABB box2) {
         return (box1.minX - box2.maxX) < -COLLISION_EPSILON && (box1.maxX - box2.minX) > COLLISION_EPSILON &&
                (box1.minY - box2.maxY) < -COLLISION_EPSILON && (box1.maxY - box2.minY) > COLLISION_EPSILON &&
diff --git a/src/main/java/net/minecraft/world/level/BlockCollisions.java b/src/main/java/net/minecraft/world/level/BlockCollisions.java
index 1b6f72932fbdd567a1534bcf15e8a610b00f974d..c9004656453ab8354e7b3a13676f58882db0138b 100644
--- a/src/main/java/net/minecraft/world/level/BlockCollisions.java
+++ b/src/main/java/net/minecraft/world/level/BlockCollisions.java
@@ -105,7 +105,7 @@ public class BlockCollisions<T> extends AbstractIterator<T> {
 
                 VoxelShape voxelShape = blockState.getCollisionShape(this.collisionGetter, this.pos, this.context);
                 if (voxelShape == Shapes.block()) {
-                    if (!io.papermc.paper.util.CollisionUtil.voxelShapeIntersect(this.box, (double)i, (double)j, (double)k, (double)i + 1.0D, (double)j + 1.0D, (double)k + 1.0D)) { // Paper - keep vanilla behavior for voxelshape intersection - See comment in CollisionUtil
+                    if (!io.papermc.paper.util.CollisionUtil.voxelShapeIntersectWithOutEpsilon(this.box, (double)i, (double)j, (double)k, (double)i + 1.0D, (double)j + 1.0D, (double)k + 1.0D)) { // Paper - keep vanilla behavior for voxelshape intersection - See comment in CollisionUtil
                         continue;
                     }
 
