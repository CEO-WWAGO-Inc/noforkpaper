From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: mohammed jasem alaajel <xrambad@gmail.com>
Date: Wed, 19 Apr 2023 09:43:46 +0400
Subject: [PATCH] Implement event calling for AttemptItemMergeEvent


diff --git a/src/main/java/net/minecraft/world/entity/item/ItemEntity.java b/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
index d47b3ac633e7936d30abfda6fc46c2c7412d76fe..2d39763929e0cf6f4009ba629753ae04057a4881 100644
--- a/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
+++ b/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
@@ -289,7 +289,7 @@ public class ItemEntity extends Entity implements TraceableEntity {
     private void tryToMerge(ItemEntity other) {
         ItemStack itemstack = this.getItem();
         ItemStack itemstack1 = other.getItem();
-
+        if (org.bukkit.craftbukkit.event.CraftEventFactory.callAttemptItemMergeEvent(other, this).isCancelled()) return; // Paper - AttemptItemMergeEvent
         if (Objects.equals(this.target, other.target) && ItemEntity.areMergable(itemstack, itemstack1)) {
             if (true || itemstack1.getCount() < itemstack.getCount()) { // Spigot
                 ItemEntity.merge(this, itemstack, other, itemstack1);
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 819c9c020f4d5a1373f68850134960d24b8fc308..5ef16cc2566f9735bcfe6ceee1031d2e2e61079f 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -174,6 +174,7 @@ import org.bukkit.event.entity.FoodLevelChangeEvent;
 import org.bukkit.event.entity.HorseJumpEvent;
 import org.bukkit.event.entity.ItemDespawnEvent;
 import org.bukkit.event.entity.ItemMergeEvent;
+import org.bukkit.event.entity.AttemptItemMergeEvent; // Paper - AttemptItemMergeEvent
 import org.bukkit.event.entity.ItemSpawnEvent;
 import org.bukkit.event.entity.LingeringPotionSplashEvent;
 import org.bukkit.event.entity.PigZapEvent;
@@ -795,6 +796,20 @@ public class CraftEventFactory {
         entity.getServer().getPluginManager().callEvent(event);
         return event;
     }
+    // Paper start - AttemptItemMergeEvent
+    /**
+     * AttemptItemMergeEvent
+     */
+    public static AttemptItemMergeEvent callAttemptItemMergeEvent(ItemEntity merging, ItemEntity mergingWith) {
+        org.bukkit.entity.Item entityMerging = (org.bukkit.entity.Item) merging.getBukkitEntity();
+        org.bukkit.entity.Item entityMergingWith = (org.bukkit.entity.Item) mergingWith.getBukkitEntity();
+
+        AttemptItemMergeEvent event = new AttemptItemMergeEvent(entityMerging, entityMergingWith);
+
+        Bukkit.getPluginManager().callEvent(event);
+        return event;
+    }
+    // Paper end
 
     /**
      * ItemMergeEvent
