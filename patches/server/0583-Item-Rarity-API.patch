From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Fri, 12 Mar 2021 17:09:42 -0800
Subject: [PATCH] Item Rarity API

== AT ==
public net.minecraft.world.item.Item rarity

diff --git a/src/main/java/io/papermc/paper/APIBridgeImpl.java b/src/main/java/io/papermc/paper/APIBridgeImpl.java
index fa249d4f6934a45313244d2cac302fa9b4219a2b..36acb5ffe30ecec1e104a44e9bbb824d9c8ddfbe 100644
--- a/src/main/java/io/papermc/paper/APIBridgeImpl.java
+++ b/src/main/java/io/papermc/paper/APIBridgeImpl.java
@@ -7,6 +7,7 @@ import com.destroystokyo.paper.util.VersionFetcher;
 import com.google.common.base.Preconditions;
 import io.papermc.paper.adventure.PaperAdventure;
 import io.papermc.paper.configuration.GlobalConfiguration;
+import io.papermc.paper.inventory.ItemRarity;
 import java.io.ByteArrayInputStream;
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;
@@ -17,9 +18,11 @@ import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.NbtIo;
 import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.dedicated.DedicatedServer;
+import net.minecraft.world.item.Item;
 import org.bukkit.Material;
 import org.bukkit.command.CommandSender;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
+import org.bukkit.craftbukkit.util.CraftMagicNumbers;
 import org.bukkit.entity.Entity;
 import org.bukkit.inventory.ItemStack;
 import org.checkerframework.checker.nullness.qual.NonNull;
@@ -98,4 +101,18 @@ public final class APIBridgeImpl implements APIBridge {
     public String getMainLevelName() {
         return ((DedicatedServer) MinecraftServer.getServer()).getProperties().levelName;
     }
+
+    @Override
+    public ItemRarity getItemRarity(final Material material) {
+        Item item = CraftMagicNumbers.getItem(material);
+        if (item == null) {
+            throw new IllegalArgumentException(material + " is not an item, and rarity does not apply to blocks");
+        }
+        return ItemRarity.values()[item.rarity.ordinal()];
+    }
+
+    @Override
+    public ItemRarity getItemStackRarity(final ItemStack itemStack) {
+        return ItemRarity.values()[CraftMagicNumbers.getItem(itemStack.getType()).getRarity(CraftItemStack.asNMSCopy(itemStack)).ordinal()];
+    }
 }
diff --git a/src/test/java/io/papermc/paper/inventory/ItemRarityTest.java b/src/test/java/io/papermc/paper/inventory/ItemRarityTest.java
new file mode 100644
index 0000000000000000000000000000000000000000..38e6d42098f216b1d24f50386e7be98181122d8d
--- /dev/null
+++ b/src/test/java/io/papermc/paper/inventory/ItemRarityTest.java
@@ -0,0 +1,24 @@
+package io.papermc.paper.inventory;
+
+import io.papermc.paper.adventure.PaperAdventure;
+import net.minecraft.world.item.Rarity;
+import org.junit.Test;
+
+import static org.junit.Assert.assertEquals;
+
+public class ItemRarityTest {
+
+    @Test
+    public void testConvertFromNmsToBukkit() {
+        for (Rarity nmsRarity : Rarity.values()) {
+            assertEquals("rarity names are mis-matched", ItemRarity.values()[nmsRarity.ordinal()].name(), nmsRarity.name());
+        }
+    }
+
+    @Test
+    public void testRarityFormatting() {
+        for (Rarity nmsRarity : Rarity.values()) {
+            assertEquals("rarity formatting is mis-matched", nmsRarity.color, PaperAdventure.asVanilla(ItemRarity.values()[nmsRarity.ordinal()].color));
+        }
+    }
+}
