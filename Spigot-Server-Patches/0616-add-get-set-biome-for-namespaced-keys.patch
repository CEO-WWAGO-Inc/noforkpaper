From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Thonk <30448663+ExcessiveAmountsOfZombies@users.noreply.github.com>
Date: Sun, 13 Dec 2020 23:12:42 -0600
Subject: [PATCH] add get/set biome for namespaced keys


diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index b71316cce3bdbf3485be456f0260c6b3463cff8e..e57703abb8981e887d85e291eaac2b9cdbd6036e 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -103,6 +103,7 @@ import org.bukkit.Effect;
 import org.bukkit.FluidCollisionMode;
 import org.bukkit.GameRule;
 import org.bukkit.Location;
+import org.bukkit.NamespacedKey;
 import org.bukkit.Particle;
 import org.bukkit.Raid;
 import org.bukkit.Sound;
@@ -1087,6 +1088,28 @@ public class CraftWorld implements World {
         return CraftBlock.biomeBaseToBiome(getHandle().r().b(IRegistry.ay), this.world.getBiome(x >> 2, y >> 2, z >> 2));
     }
 
+    // Paper start
+    @Override
+    public NamespacedKey getBiomeKey(int x, int y, int z) {
+        return CraftBlock.biomeBaseToKey(getHandle().r().b(IRegistry.ay), this.world.getBiome(x >> 2, y >> 2, z >> 2));
+    }
+
+
+    @Override
+    public void setBiome(int x, int y, int z, NamespacedKey key) {
+        BiomeBase base = CraftBlock.biomeToBiomeBase(getHandle().r().b(IRegistry.ay), key);
+        BlockPosition pos = new BlockPosition(x, 0, z);
+        if (this.world.isLoaded(pos) && base != null) {
+            net.minecraft.server.Chunk chunk = this.world.getChunkAtWorldCoords(pos);
+
+            if (chunk != null) {
+                chunk.getBiomeIndex().setBiome(x >> 2, y >> 2, z >> 2, base);
+
+                chunk.markDirty(); // SPIGOT-2890
+            }
+        }
+    }
+    // paper end
     @Override
     public void setBiome(int x, int z, Biome bio) {
         for (int y = 0; y < getMaxHeight(); y++) {
diff --git a/src/main/java/org/bukkit/craftbukkit/block/CraftBlock.java b/src/main/java/org/bukkit/craftbukkit/block/CraftBlock.java
index 6fde449aca446001145e49b5859725f840cc317c..e03788fc20fffe54b1e24a5c64cedffb6fa0d638 100644
--- a/src/main/java/org/bukkit/craftbukkit/block/CraftBlock.java
+++ b/src/main/java/org/bukkit/craftbukkit/block/CraftBlock.java
@@ -33,6 +33,7 @@ import org.bukkit.Chunk;
 import org.bukkit.FluidCollisionMode;
 import org.bukkit.Location;
 import org.bukkit.Material;
+import org.bukkit.NamespacedKey;
 import org.bukkit.Registry;
 import org.bukkit.World;
 import org.bukkit.block.Biome;
@@ -503,6 +504,16 @@ public class CraftBlock implements Block {
         return getWorld().getBiome(getX(), getY(), getZ());
     }
 
+    // Paper start
+    public NamespacedKey getBiomeKey() {
+        return getWorld().getBiomeKey(getX(), getY(), getZ());
+    }
+
+    @Override
+    public void setBiome(NamespacedKey key) {
+        getWorld().setBiome(getX(), getY(), getZ(), key);
+    }
+    // Paper end
     @Override
     public void setBiome(Biome bio) {
         getWorld().setBiome(getX(), getY(), getZ(), bio);
@@ -515,6 +526,19 @@ public class CraftBlock implements Block {
 
         return Registry.BIOME.get(CraftNamespacedKey.fromMinecraft(registry.getKey(base)));
     }
+    // Paper start
+    public static NamespacedKey biomeBaseToKey(IRegistry<BiomeBase> registry, BiomeBase base) {
+        if (base == null) {
+            return null;
+        }
+
+        return CraftNamespacedKey.fromMinecraft(registry.getKey(base));
+    }
+
+    public static BiomeBase biomeToBiomeBase(IRegistry<BiomeBase> registry, NamespacedKey key) {
+        return registry.get(CraftNamespacedKey.toMinecraft(key));
+    }
+    // Paper end
 
     public static BiomeBase biomeToBiomeBase(IRegistry<BiomeBase> registry, Biome bio) {
         if (bio == null) {
