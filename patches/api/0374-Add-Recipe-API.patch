From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: lexikiq <noellekiq@gmail.com>
Date: Thu, 15 Jul 2021 01:39:12 -0400
Subject: [PATCH] Add Recipe API

Adds methods to utilize the RecipeManager to obtain recipes

diff --git a/src/main/java/io/papermc/paper/inventory/RecipeType.java b/src/main/java/io/papermc/paper/inventory/RecipeType.java
new file mode 100644
index 0000000000000000000000000000000000000000..ae47efbc112a22ab69546ced519f78c6b3db471a
--- /dev/null
+++ b/src/main/java/io/papermc/paper/inventory/RecipeType.java
@@ -0,0 +1,87 @@
+package io.papermc.paper.inventory;
+
+import io.papermc.paper.registry.Reference;
+import org.bukkit.Keyed;
+import org.bukkit.NamespacedKey;
+import org.bukkit.Registry;
+import org.bukkit.inventory.BlastingRecipe;
+import org.bukkit.inventory.CampfireRecipe;
+import org.bukkit.inventory.CraftingInventory;
+import org.bukkit.inventory.FurnaceRecipe;
+import org.bukkit.inventory.Inventory;
+import org.bukkit.inventory.Recipe;
+import org.bukkit.inventory.SmithingRecipe;
+import org.bukkit.inventory.SmokingRecipe;
+import org.bukkit.inventory.StonecuttingRecipe;
+import org.jetbrains.annotations.NotNull;
+
+import java.util.Objects;
+
+/**
+ * A type of recipe registered by the game or a datapack.
+ * The most common recipe type is the {@link #CRAFTING crafting table} type.
+ *
+ * @param <R> recipe class this type represents
+ * @param <I> inventory class used for matching recipes
+ */
+public class RecipeType<R extends Recipe, I extends Inventory> implements Keyed {
+    private final @NotNull NamespacedKey key;
+
+    /**
+     * Creates a recipe type given the provided key.
+     *
+     * @param key a {@link NamespacedKey#fromString(String) NamespacedKey-like string} that
+     *            identifies a type of recipe
+     */
+    public RecipeType(@NotNull String key) {
+        this.key = Objects.requireNonNull(NamespacedKey.fromString(key), "Unable to parse key '" + key + "'");
+    }
+
+    /**
+     * Creates a recipe type for the provided key.
+     *
+     * @param key the key that identifies a type of recipe.
+     */
+    public RecipeType(@NotNull NamespacedKey key) {
+        this.key = Objects.requireNonNull(key, "key cannot be null");
+    }
+
+    @Override
+    public @NotNull NamespacedKey getKey() {
+        return key;
+    }
+
+    private static <R extends Recipe, C extends Inventory> Reference<RecipeType<R, C>> register(final @NotNull String id) {
+        Object reference = Reference.create(Registry.RECIPE_TYPE, NamespacedKey.minecraft(id));
+        return (Reference<RecipeType<R, C>>) reference;
+    }
+
+    /**
+     * Recipes for crafting in a {@link org.bukkit.Material#CRAFTING_TABLE CRAFTING_TABLE}.
+     */
+    public static final Reference<RecipeType<Recipe, CraftingInventory>> CRAFTING = register("crafting");
+    /**
+     * Recipes for smelting inside a {@link org.bukkit.Material#FURNACE FURNACE}.
+     */
+    public static final Reference<RecipeType<FurnaceRecipe, Inventory>> SMELTING = register("smelting");
+    /**
+     * Recipes for smelting inside a {@link org.bukkit.Material#BLAST_FURNACE BLAST_FURNACE}.
+     */
+    public static final Reference<RecipeType<BlastingRecipe, Inventory>> BLASTING = register("blasting");
+    /**
+     * Recipes for smelting inside a {@link org.bukkit.Material#SMOKER SMOKER}.
+     */
+    public static final Reference<RecipeType<SmokingRecipe, Inventory>> SMOKING = register("smoking");
+    /**
+     * Recipes for smelting on a {@link org.bukkit.Material#CAMPFIRE CAMPFIRE}.
+     */
+    public static final Reference<RecipeType<CampfireRecipe, Inventory>> CAMPFIRE_COOKING = register("campfire_cooking");
+    /**
+     * Recipes for cutting in a {@link org.bukkit.Material#STONECUTTER STONECUTTER}.
+     */
+    public static final Reference<RecipeType<StonecuttingRecipe, Inventory>> STONECUTTING = register("stonecutting");
+    /**
+     * Recipes for upgrading items in a {@link org.bukkit.Material#SMITHING_TABLE SMITHING_TABLE}.
+     */
+    public static final Reference<RecipeType<SmithingRecipe, Inventory>> SMITHING = register("smithing");
+}
diff --git a/src/main/java/org/bukkit/Bukkit.java b/src/main/java/org/bukkit/Bukkit.java
index 944f9b87a11472ac6d7e328acc00bf09f899e648..3804690913598f8b31d68be7624bb2b0cd305eea 100644
--- a/src/main/java/org/bukkit/Bukkit.java
+++ b/src/main/java/org/bukkit/Bukkit.java
@@ -2306,6 +2306,16 @@ public final class Bukkit {
     public static @NotNull org.bukkit.potion.PotionBrewer getPotionBrewer() {
         return server.getPotionBrewer();
     }
+
+    /**
+     * Gets all recipes of a certain type.
+     *
+     * @param recipeType recipe type to check against
+     * @return all recipes registered under the input type
+     */
+    public static @NotNull <R extends org.bukkit.inventory.Recipe> List<R> getAllRecipes(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType) {
+        return server.getAllRecipes(recipeType);
+    }
     // Paper end
 
     @NotNull
diff --git a/src/main/java/org/bukkit/Registry.java b/src/main/java/org/bukkit/Registry.java
index 41363490b1e72d53ab3f1f26fe464858bb7b8f72..d96776b0af2ae1d39961db7aa4a7da2e8449b016 100644
--- a/src/main/java/org/bukkit/Registry.java
+++ b/src/main/java/org/bukkit/Registry.java
@@ -233,6 +233,12 @@ public interface Registry<T extends Keyed> extends Iterable<T> {
             return StructureType.getStructureTypes().values().iterator();
         }
     };
+    /**
+     * Recipe types.
+     *
+     * @see io.papermc.paper.inventory.RecipeType RecipeType
+     */
+    Registry<io.papermc.paper.inventory.RecipeType<?, ?>> RECIPE_TYPE = Bukkit.getUnsafe().registryFor((Class<io.papermc.paper.inventory.RecipeType<?, ?>>) (Object) io.papermc.paper.inventory.RecipeType.class);
     // Paper end
 
     /**
diff --git a/src/main/java/org/bukkit/Server.java b/src/main/java/org/bukkit/Server.java
index f63587cfa651a3893d2efa3730dc80f271d56b1c..1aafd95dc21c400ad9fdee6676c64fd2a172a5e2 100644
--- a/src/main/java/org/bukkit/Server.java
+++ b/src/main/java/org/bukkit/Server.java
@@ -2002,5 +2002,14 @@ public interface Server extends PluginMessageRecipient, net.kyori.adventure.audi
      * @return the potion brewer
      */
     @NotNull org.bukkit.potion.PotionBrewer getPotionBrewer();
+
+    /**
+     * Gets all recipes of a certain type.
+     *
+     * @param recipeType recipe type to check against
+     * @return all recipes registered under the input type
+     */
+    @NotNull
+    <R extends org.bukkit.inventory.Recipe> List<R> getAllRecipes(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType);
     // Paper end
 }
diff --git a/src/main/java/org/bukkit/World.java b/src/main/java/org/bukkit/World.java
index 8a688583e65cd22e0417f9fd24e51803486d095e..c9961f764872d149077cf4c871115dcaef32a4a0 100644
--- a/src/main/java/org/bukkit/World.java
+++ b/src/main/java/org/bukkit/World.java
@@ -3929,6 +3929,92 @@ public interface World extends RegionAccessor, WorldInfo, PluginMessageRecipient
     @Nullable
     public DragonBattle getEnderDragonBattle();
 
+    // Paper start
+    /**
+     * Gets a recipe from the items inside of an inventory.
+     *
+     * @param recipeType recipe type to check against
+     * @param inventory the inventory to check
+     * @return a recipe resulting from the input items, or null if no result is found
+     */
+    @Nullable
+    <R extends org.bukkit.inventory.Recipe, I extends org.bukkit.inventory.Inventory> R getRecipe(io.papermc.paper.inventory.@NotNull RecipeType<R, I> recipeType, @NotNull I inventory);
+
+    /**
+     * Gets a recipe from a collection of items.
+     * <p>
+     * The collection should be ordered from left-to-right, top-to-bottom.
+     * The zeroth index would be the top left slot of a crafting table,
+     * the first index would be the top middle slot, et cetera.
+     * </p>
+     * The collection of items must not be null, but the items contained inside it may be null.
+     *
+     * @param recipeType recipe type to check against
+     * @param items items to craft with
+     * @return a recipe resulting from the input items, or null if no result is found
+     */
+    @Nullable
+    <R extends org.bukkit.inventory.Recipe> R getRecipe(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType, @NotNull Collection<@Nullable ItemStack> items);
+
+    /**
+     * Gets a recipe from an index of items.
+     * <p>
+     * The index should be ordered from left-to-right, top-to-bottom.
+     * The zeroth index would be the top left slot of a crafting table,
+     * the first index would be the top middle slot, et cetera.
+     * </p>
+     * The array of items must not be null, but the items contained inside it may be null.
+     *
+     * @param recipeType recipe type to check against
+     * @param items items to craft with
+     * @return a recipe resulting from the input items, or null if no result is found
+     */
+    @Nullable
+    <R extends org.bukkit.inventory.Recipe> R getRecipe(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType, ItemStack @NotNull ... items);
+
+    /**
+     * Gets all applicable recipes from the items inside of an inventory.
+     *
+     * @param recipeType recipe type to check against
+     * @param inventory the inventory to check
+     * @return the recipes resulting from the input items
+     */
+    @NotNull
+    <R extends org.bukkit.inventory.Recipe, I extends org.bukkit.inventory.Inventory> List<R> getRecipes(io.papermc.paper.inventory.@NotNull RecipeType<R, I> recipeType, @NotNull I inventory);
+
+    /**
+     * Gets all applicable recipes from a collection of items.
+     * <p>
+     * The collection should be ordered from left-to-right, top-to-bottom.
+     * The zeroth index would be the top left slot of a crafting table,
+     * the first index would be the top middle slot, et cetera.
+     * </p>
+     * The collection of items must not be null, but the items contained inside it may be null.
+     *
+     * @param recipeType recipe type to check against
+     * @param items items to craft with
+     * @return the recipes resulting from the input items
+     */
+    @Nullable
+    <R extends org.bukkit.inventory.Recipe> List<R> getRecipes(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType, @NotNull Collection<@Nullable ItemStack> items);
+
+    /**
+     * Gets all applicable recipes from an array of items.
+     * <p>
+     * The array should be ordered from left-to-right, top-to-bottom.
+     * The zeroth index would be the top left slot of a crafting table,
+     * the first index would be the top middle slot, et cetera.
+     * </p>
+     * The array of items must not be null, but the items contained inside it may be null.
+     *
+     * @param recipeType recipe type to check against
+     * @param items items to craft with
+     * @return the recipes resulting from the input items
+     */
+    @NotNull
+    <R extends org.bukkit.inventory.Recipe> List<R> getRecipes(io.papermc.paper.inventory.@NotNull RecipeType<R, ?> recipeType, ItemStack @NotNull ... items);
+    // Paper end
+
     /**
      * Represents various map environment types that a world may be
      */
