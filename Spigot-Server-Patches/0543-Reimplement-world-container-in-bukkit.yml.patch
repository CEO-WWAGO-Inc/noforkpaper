From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: TheMolkaPL <themolkapl@gmail.com>
Date: Fri, 10 Jul 2020 19:56:14 +0200
Subject: [PATCH] Reimplement world-container in bukkit.yml


diff --git a/src/main/java/net/minecraft/server/Main.java b/src/main/java/net/minecraft/server/Main.java
index 2f29d7040d37e8be2ba5f8f634011e069a07db2f..53a37fdd528bad9a7ac417a0a675a12daeff31c7 100644
--- a/src/main/java/net/minecraft/server/Main.java
+++ b/src/main/java/net/minecraft/server/Main.java
@@ -26,6 +26,8 @@ public class Main {
 
     private static final Logger LOGGER = LogManager.getLogger();
 
+    public static org.bukkit.configuration.file.YamlConfiguration bukkitConfiguration = new org.bukkit.configuration.file.YamlConfiguration(); // Paper - load bukkit.yml  earlier
+
     public Main() {}
 
     public static void main(final OptionSet optionset) { // CraftBukkit - replaces main(String[] astring)
@@ -86,7 +88,32 @@ public class Main {
                 return;
             }
 
-            File file = (File) optionset.valueOf("universe"); // CraftBukkit
+            // Paper start - load bukkit.yml earlier
+            File bukkitConfigurationFile = (File) optionset.valueOf("bukkit-settings");
+            if (bukkitConfigurationFile.exists()) {
+                try {
+                    bukkitConfiguration.load(bukkitConfigurationFile);
+                } catch (java.io.IOException | org.bukkit.configuration.InvalidConfigurationException e) {
+                    Main.LOGGER.fatal("Cannot load {}", bukkitConfigurationFile, e);
+                    return;
+                }
+            }
+
+            org.bukkit.configuration.file.YamlConfiguration defaultBukkitConfiguration = new org.bukkit.configuration.file.YamlConfiguration();
+            java.io.InputStream inputStream = Main.class.getClassLoader().getResourceAsStream("configurations/bukkit.yml");
+            if (inputStream == null) {
+                throw new java.io.IOException("Missing default bukkit.yml file");
+            }
+
+            try (java.io.InputStreamReader inputStreamReader = new java.io.InputStreamReader(inputStream, com.google.common.base.Charsets.UTF_8)) {
+                defaultBukkitConfiguration.load(inputStreamReader);
+            }
+
+            bukkitConfiguration.setDefaults(defaultBukkitConfiguration);
+            bukkitConfiguration.options().copyDefaults(true);
+            // Paper end
+
+            File file = bukkitConfiguration.isString("settings.world-container") ? new File(bukkitConfiguration.getString("settings.world-container")) : (File) optionset.valueOf("universe"); // Paper - read settings.world-container
             YggdrasilAuthenticationService yggdrasilauthenticationservice = new com.destroystokyo.paper.profile.PaperAuthenticationService(Proxy.NO_PROXY, UUID.randomUUID().toString()); // Paper
             MinecraftSessionService minecraftsessionservice = yggdrasilauthenticationservice.createMinecraftSessionService();
             GameProfileRepository gameprofilerepository = yggdrasilauthenticationservice.createProfileRepository();
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index d8103ab0d542ced4f30b88ceb4fc4c3eedd5d9a0..cc20835a4dc3e810248e5307be78baef7504bfb8 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -300,9 +300,12 @@ public final class CraftServer implements Server {
             getLogger().info("Console input is disabled due to --noconsole command argument");
         }
 
-        configuration = YamlConfiguration.loadConfiguration(getConfigFile());
-        configuration.options().copyDefaults(true);
-        configuration.setDefaults(YamlConfiguration.loadConfiguration(new InputStreamReader(getClass().getClassLoader().getResourceAsStream("configurations/bukkit.yml"), Charsets.UTF_8)));
+        // Paper start - load bukkit.yml earlier
+        configuration = net.minecraft.server.Main.bukkitConfiguration; net.minecraft.server.Main.bukkitConfiguration = null;
+        //configuration = new YamlConfiguration();
+        //configuration.options().copyDefaults(true);
+        //configuration.setDefaults(YamlConfiguration.loadConfiguration(new InputStreamReader(getClass().getClassLoader().getResourceAsStream("configurations/bukkit.yml"), Charsets.UTF_8)));
+        // Paper end
         ConfigurationSection legacyAlias = null;
         if (!configuration.isString("aliases")) {
             legacyAlias = configuration.getConfigurationSection("aliases");
