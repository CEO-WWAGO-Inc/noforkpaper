From d75f290664d6f8822e6bd7b8a2d8ea2492897dbb Mon Sep 17 00:00:00 2001
From: cryptite <cryptite@gmail.com>
Date: Tue, 17 Dec 2019 15:29:44 -0600
Subject: [PATCH] Dont recalculate permissions on world change

Often, but not 100% of the time, the server will reconstruct and recalculate the Command Map sent to players
when they change worlds. This is often laggy; worse-so depending on the extent of the tab-completed commands to be sent.
In our case, the map sent to the player on login is sufficient and is not tossed by the client for world changes.

As a result, we opt not to recalculate this on world change and this prevents a fairly heavy, and consistent main-thread
lagspike whenever players change worlds, which can be a lot.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index bce502181..0cc235338 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -653,4 +653,10 @@ public class PaperWorldConfig {
         disableHopperMoveEvents = getBoolean("hopper.disable-move-event", disableHopperMoveEvents);
         log("Hopper Move Item Events: " + (disableHopperMoveEvents ? "disabled" : "enabled"));
     }
+
+    public boolean recalculatePermsOnWorldChange = false;
+    private void recalculatePermsOnWorldChange() {
+	    recalculatePermsOnWorldChange = getBoolean("recalculate-perms-on-world-change", recalculatePermsOnWorldChange);
+    }
+
 }
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index 7b79ee4fe..0d110cb4b 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -712,7 +712,9 @@ public abstract class PlayerList {
         entityplayer1.playerConnection.sendPacket(new PacketPlayOutServerDifficulty(worlddata.getDifficulty(), worlddata.isDifficultyLocked()));
         entityplayer1.playerConnection.sendPacket(new PacketPlayOutExperience(entityplayer1.exp, entityplayer1.expTotal, entityplayer1.expLevel));
         this.a(entityplayer1, worldserver);
+        movedToWorld = true; // Paper
         this.d(entityplayer1);
+        movedToWorld = false; // Paper
         if (!entityplayer.playerConnection.isDisconnected()) {
             worldserver.addPlayerRespawn(entityplayer1);
             this.players.add(entityplayer1);
@@ -754,6 +756,8 @@ public abstract class PlayerList {
         // CraftBukkit end
         return entityplayer1;
     }
+    
+    private boolean movedToWorld = false; // Paper
 
     public void d(EntityPlayer entityplayer) {
         GameProfile gameprofile = entityplayer.getProfile();
@@ -907,7 +911,7 @@ public abstract class PlayerList {
             entityplayer.playerConnection.sendPacket(new PacketPlayOutEntityStatus(entityplayer, b0));
         }
 
-        entityplayer.getBukkitEntity().recalculatePermissions(); // CraftBukkit
+        if(!(movedToWorld && !entityplayer.getWorldServer().paperConfig.recalculatePermsOnWorldChange)) entityplayer.getBukkitEntity().recalculatePermissions(); // CraftBukkit // Paper
         this.server.getCommandDispatcher().a(entityplayer);
     }
 
-- 
2.21.1 (Apple Git-122.3)

