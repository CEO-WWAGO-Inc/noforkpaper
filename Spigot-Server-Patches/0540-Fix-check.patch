From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jan Tuck <jan@tuck.dk>
Date: Mon, 6 Jul 2020 03:56:03 +0200
Subject: [PATCH] Fix check.


diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 4e3360d38b24f2ba0efacd9881418f1e6bff25f5..593e622814ab4d36962ea8e0bff305e3e146fab8 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -1578,16 +1578,18 @@ public class CraftEventFactory {
            I only know of this happening frequently with anvils and the level req set to 0, so i will limit it to that.
          */
         if (event instanceof PrepareAnvilEvent) {
-            event.getViewers().forEach(viewer -> {
-                if (viewer instanceof Player) {
-                    net.minecraft.server.EntityPlayer player = ((CraftPlayer) viewer).getHandle();
-                    boolean before = player.e; // The use i found of it did this same thing by setting to false, broadcasting and setting to true.
-                    if (!player.e)
-                        player.e = false;
-                    player.broadcastCarriedItem();
-                    player.e = before;
-                }
-            });
+             if (((org.bukkit.inventory.AnvilInventory)view.getTopInventory()).getRepairCost() == 0) {
+                event.getViewers().forEach(viewer -> {
+                    if (viewer instanceof Player) {
+                        net.minecraft.server.EntityPlayer player = ((CraftPlayer) viewer).getHandle();
+                        boolean before = player.e; // It gotta be false for this method to work :shrug:
+                        if (player.e)
+                            player.e = false;
+                        player.broadcastCarriedItem();
+                        player.e = before;
+                    }
+                });
+            }
         }
     }
     // Paper end
