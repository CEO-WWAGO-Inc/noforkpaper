From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Thu, 2 Jul 2020 16:12:10 -0700
Subject: [PATCH] added PlayerTradeEvent


diff --git a/src/main/java/net/minecraft/server/EntityVillagerAbstract.java b/src/main/java/net/minecraft/server/EntityVillagerAbstract.java
index 81823b5d5ef17479583fda0121c95091175fdf1e..966d93b4594d11b8ef701b50a53647e9b35071f2 100644
--- a/src/main/java/net/minecraft/server/EntityVillagerAbstract.java
+++ b/src/main/java/net/minecraft/server/EntityVillagerAbstract.java
@@ -101,13 +101,23 @@ public abstract class EntityVillagerAbstract extends EntityAgeable implements NP
 
     @Override
     public void a(MerchantRecipe merchantrecipe) {
-        merchantrecipe.increaseUses();
-        this.e = -this.D();
-        this.b(merchantrecipe);
+        // Paper start
         if (this.tradingPlayer instanceof EntityPlayer) {
-            CriterionTriggers.s.a((EntityPlayer) this.tradingPlayer, this, merchantrecipe.getSellingItem());
+            com.destroystokyo.paper.event.player.PlayerTradeEvent event = new com.destroystokyo.paper.event.player.PlayerTradeEvent(((EntityPlayer) this.tradingPlayer).getBukkitEntity(), (AbstractVillager) this.getBukkitEntity(), merchantrecipe.asBukkit(), true, true);
+            event.callEvent();
+            if (!event.isCancelled()) {
+                MerchantRecipe recipe = CraftMerchantRecipe.fromBukkit(event.getTrade()).toMinecraft();
+                if (event.willIncreaseTradeUses()) recipe.increaseUses();
+                this.e = -this.D();
+                if (event.isRewardingExp()) this.b(recipe);
+                CriterionTriggers.s.a((EntityPlayer) this.tradingPlayer, this, recipe.getSellingItem());
+            }
+        } else {
+            merchantrecipe.increaseUses();
+            this.e = -this.D();
+            this.b(merchantrecipe);
         }
-
+        // Paper end
     }
 
     protected abstract void b(MerchantRecipe merchantrecipe);
