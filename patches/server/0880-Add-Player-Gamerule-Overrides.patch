From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Owen1212055 <23108066+Owen1212055@users.noreply.github.com>
Date: Wed, 6 Oct 2021 18:16:49 -0400
Subject: [PATCH] Add Player Gamerule Overrides


diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index 02dc93c394d37c9a84aa4a58d80615c403c54fb9..ee850de3ec5135d1c83b17bb9773ddc1d116119e 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -269,6 +269,10 @@ public abstract class PlayerList {
         GameRules gamerules = worldserver1.getGameRules();
         boolean flag = gamerules.getBoolean(GameRules.RULE_DO_IMMEDIATE_RESPAWN);
         boolean flag1 = gamerules.getBoolean(GameRules.RULE_REDUCEDDEBUGINFO);
+        // Paper start - Add gamerule player overrides
+        flag = spawnPlayer.getImmediateRespawnOverride().toBooleanOrElse(flag);
+        flag1 = spawnPlayer.getReducedDebugInfoOverride().toBooleanOrElse(flag1);
+        // Paper end - Add gamerule player overrides
 
         // Spigot - view distance
         playerconnection.send(new ClientboundLoginPacket(player.getId(), worlddata.isHardcore(), player.gameMode.getGameModeForPlayer(), player.gameMode.getPreviousGameModeForPlayer(), this.server.levelKeys(), this.registryHolder, worldserver1.dimensionTypeRegistration(), worldserver1.dimension(), BiomeManager.obfuscateSeed(worldserver1.getSeed()), this.getMaxPlayers(), worldserver1.getChunkSource().chunkMap.playerChunkManager.getTargetSendDistance(), worldserver1.getChunkSource().chunkMap.playerChunkManager.getTargetTickViewDistance(), flag1, !flag, worldserver1.isDebug(), worldserver1.isFlat())); // Paper - replace old player chunk management
@@ -1293,9 +1297,9 @@ public abstract class PlayerList {
         player.getBukkitEntity().updateScaledHealth(); // CraftBukkit - Update scaled health on respawn and worldchange
         player.connection.send(new ClientboundSetCarriedItemPacket(player.getInventory().selected));
         // CraftBukkit start - from GameRules
-        int i = player.level.getGameRules().getBoolean(GameRules.RULE_REDUCEDDEBUGINFO) ? 22 : 23;
+        int i = player.getBukkitEntity().getReducedDebugInfoOverride().toBooleanOrElse(player.level.getGameRules().getBoolean(GameRules.RULE_REDUCEDDEBUGINFO)) ? 22 : 23; // Paper - Add gamerule player overrides
         player.connection.send(new ClientboundEntityEventPacket(player, (byte) i));
-        float immediateRespawn = player.level.getGameRules().getBoolean(GameRules.RULE_DO_IMMEDIATE_RESPAWN) ? 1.0F: 0.0F;
+        float immediateRespawn = player.getBukkitEntity().getImmediateRespawnOverride().toBooleanOrElse(player.level.getGameRules().getBoolean(GameRules.RULE_DO_IMMEDIATE_RESPAWN)) ? 1.0F: 0.0F; // Paper - Add gamerule player overrides
         player.connection.send(new ClientboundGameEventPacket(ClientboundGameEventPacket.IMMEDIATE_RESPAWN, immediateRespawn));
         // CraftBukkit end
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 603e9234294c01f1cde4bfc0b0053e69b99861d9..55807550410574863898282bc23a6b5540a65c00 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -164,6 +164,10 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     private static final boolean DISABLE_CHANNEL_LIMIT = System.getProperty("paper.disableChannelLimit") != null; // Paper - add a flag to disable the channel limit
     private long lastSaveTime;
     // Paper end
+    // Paper start - Add gamerule player overrides
+    public net.kyori.adventure.util.TriState immediateRespawnOverride = net.kyori.adventure.util.TriState.NOT_SET;
+    public net.kyori.adventure.util.TriState debuginfoOverride = net.kyori.adventure.util.TriState.NOT_SET;
+    // Paper end - Add gamerule player overrides
 
     public CraftPlayer(CraftServer server, ServerPlayer entity) {
         super(server, entity);
@@ -2714,4 +2718,33 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         return this.spigot;
     }
     // Spigot end
+    // Paper start - Add gamerule player overrides
+    @NotNull
+    @Override
+    public net.kyori.adventure.util.TriState getImmediateRespawnOverride() {
+        return immediateRespawnOverride;
+    }
+
+    @Override
+    public void setImmediateRespawnOverride(@NotNull net.kyori.adventure.util.TriState state) {
+        this.immediateRespawnOverride = state;
+        boolean instantRespawn = state.toBooleanOrElse(this.getHandle().level.getGameRules().getBoolean(net.minecraft.world.level.GameRules.RULE_DO_IMMEDIATE_RESPAWN));
+
+        this.getHandle().connection.send(new net.minecraft.network.protocol.game.ClientboundGameEventPacket(net.minecraft.network.protocol.game.ClientboundGameEventPacket.IMMEDIATE_RESPAWN, instantRespawn ? 1.0F : 0.0F));
+    }
+
+    @NotNull
+    @Override
+    public net.kyori.adventure.util.TriState getReducedDebugInfoOverride() {
+        return debuginfoOverride;
+    }
+
+    @Override
+    public void setReducedDebugInfoOverride(@NotNull net.kyori.adventure.util.TriState state) {
+        this.debuginfoOverride = state;
+        boolean reducedDebugbool = state.toBooleanOrElse(this.getHandle().level.getGameRules().getBoolean(net.minecraft.world.level.GameRules.RULE_REDUCEDDEBUGINFO));
+
+        this.getHandle().connection.send(new net.minecraft.network.protocol.game.ClientboundEntityEventPacket(this.getHandle(), (byte) (reducedDebugbool ? 22 : 23)));
+    }
+    // Paper end - Add gamerule player overrides
 }
