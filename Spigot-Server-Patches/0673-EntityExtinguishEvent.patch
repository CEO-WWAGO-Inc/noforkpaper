From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ivan Pekov <ivan@mrivanplays.com>
Date: Mon, 1 Feb 2021 11:54:46 +0200
Subject: [PATCH] EntityExtinguishEvent


diff --git a/src/main/java/net/minecraft/server/BlockCauldron.java b/src/main/java/net/minecraft/server/BlockCauldron.java
index 9fed3883828e7d6ca917a5eca7a7a3e37582f983..79d370abee1944defedb475584e1feeeb3bca037 100644
--- a/src/main/java/net/minecraft/server/BlockCauldron.java
+++ b/src/main/java/net/minecraft/server/BlockCauldron.java
@@ -1,6 +1,7 @@
 package net.minecraft.server;
 
 import org.bukkit.event.block.CauldronLevelChangeEvent; // CraftBukkit
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 
 public class BlockCauldron extends Block {
 
@@ -33,7 +34,7 @@ public class BlockCauldron extends Block {
             if (!this.changeLevel(world, blockposition, iblockdata, i - 1, entity, CauldronLevelChangeEvent.ChangeReason.EXTINGUISH)) {
                 return;
             }
-            entity.extinguish();
+            entity.extinguish(EntityExtinguishEvent.Reason.COLLISION); // Paper
             // this.a(world, blockposition, iblockdata, i - 1);
             // CraftBukkit end
         }
diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index f307a6361144c7e315b2e0ea45df27527cdb26ca..fe6641fa504a1f5c74136d6791fb9e8c9bc6df3a 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -5,6 +5,7 @@ import com.google.common.collect.Lists;
 import com.google.common.collect.Sets;
 import it.unimi.dsi.fastutil.objects.Object2DoubleArrayMap;
 import it.unimi.dsi.fastutil.objects.Object2DoubleMap;
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 import java.util.Arrays;
 import java.util.Collection;
 import java.util.Collections;
@@ -442,7 +443,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
             if (this.isFireProof()) {
                 this.setFireTicks(this.fireTicks - 4);
                 if (this.fireTicks < 0) {
-                    this.extinguish();
+                    this.extinguish(EntityExtinguishEvent.Reason.BURN_OUT); // Paper
                 }
             } else {
                 if (this.fireTicks % 20 == 0 && !this.aQ()) {
@@ -557,7 +558,18 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
     }
 
     public void extinguish() {
+        // Paper start - call EntityExtinguishEvent
+        extinguish(EntityExtinguishEvent.Reason.PLUGIN);
+    }
+    public void extinguish(EntityExtinguishEvent.Reason reason) {
+        EntityExtinguishEvent event = new EntityExtinguishEvent(this.getBukkitEntity(), this.fireTicks, reason);
+        org.bukkit.Bukkit.getPluginManager().callEvent(event);
+        if (!event.isCancelled()) {
         this.setFireTicks(0);
+        } else {
+            this.setFireTicks(event.getFireTicks());
+        }
+        // Paper end
     }
 
     // Paper start
@@ -1133,7 +1145,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
 
             this.fallDistance = 0.0F;
             this.inWater = true;
-            this.extinguish();
+            this.extinguish(EntityExtinguishEvent.Reason.IN_WATER); // Paper
         } else {
             this.inWater = false;
         }
diff --git a/src/main/java/net/minecraft/server/EntityArrow.java b/src/main/java/net/minecraft/server/EntityArrow.java
index 1e7f5957d879d1ba8cf2b29cf9397b8e204e4381..d573214afc7c6d5bb04da26735e475f075857be3 100644
--- a/src/main/java/net/minecraft/server/EntityArrow.java
+++ b/src/main/java/net/minecraft/server/EntityArrow.java
@@ -1,6 +1,7 @@
 package net.minecraft.server;
 
 import com.google.common.collect.Lists;
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 import it.unimi.dsi.fastutil.ints.IntOpenHashSet;
 import java.util.Arrays;
 import java.util.Collection;
@@ -121,7 +122,7 @@ public abstract class EntityArrow extends IProjectile {
         }
 
         if (this.isInWaterOrRain()) {
-            this.extinguish();
+            this.extinguish(this.isInWater() ? EntityExtinguishEvent.Reason.IN_WATER : EntityExtinguishEvent.Reason.IN_RAIN); // Paper
         }
 
         if (this.inGround && !flag) {
diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 59b00c78f8d92bcceca35d0f25e4d94b3ebdc6e2..cbe837c5925b48a132f0bd3117e3e2e9ffbbff30 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -5,6 +5,7 @@ import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.Lists;
 import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.util.Either;
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 import java.nio.charset.StandardCharsets;
 import java.util.Collection;
 import java.util.Iterator;
@@ -497,7 +498,7 @@ public abstract class EntityHuman extends EntityLiving {
         this.a(StatisticList.DEATHS);
         this.a(StatisticList.CUSTOM.b(StatisticList.TIME_SINCE_DEATH));
         this.a(StatisticList.CUSTOM.b(StatisticList.TIME_SINCE_REST));
-        this.extinguish();
+        this.extinguish(EntityExtinguishEvent.Reason.DEATH); // Paper
         this.setFlag(0, false);
     }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index b7a362bd9c5e9dae909b863335bae3a94d404a16..3cd8bb20229d9ab1517d7b167fdb82e8d53aff7f 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -10,6 +10,7 @@ import com.mojang.datafixers.util.Pair;
 import com.mojang.serialization.DataResult;
 import com.mojang.serialization.Dynamic;
 import com.mojang.serialization.DynamicOps;
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 import io.papermc.paper.event.entity.EntityMoveEvent;
 import java.util.Collection;
 import java.util.ConcurrentModificationException;
@@ -326,9 +327,17 @@ public abstract class EntityLiving extends Entity {
             }
         }
 
-        if (this.isAlive() && this.aG()) {
-            this.extinguish();
+        // Paper start - EntityExtinguishEvent
+        if (this.isAlive()) {
+            if (this.isInWater()) {
+                this.extinguish(EntityExtinguishEvent.Reason.IN_WATER);
+            } else if (this.isInRain()) {
+                this.extinguish(EntityExtinguishEvent.Reason.IN_RAIN);
+            } else if (this.isInBubbleColumn()) {
+                this.extinguish(EntityExtinguishEvent.Reason.IN_BUBBLE);
+            }
         }
+        // Paper end
 
         if (this.hurtTicks > 0) {
             --this.hurtTicks;
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index a9a409eebabae11ab84cf9bcced1f9a030b4a479..40a65358d34ab1537d578ebdb7e214b9b8ac70da 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -6,6 +6,7 @@ import com.destroystokyo.paper.event.player.PlayerClientOptionsChangeEvent; // P
 import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.util.Either;
 import com.mojang.serialization.DataResult;
+import io.papermc.paper.event.entity.EntityExtinguishEvent; // Paper
 import java.util.ArrayDeque; // Paper
 import java.util.Collection;
 import java.util.Deque; // Paper
@@ -760,7 +761,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         this.a(StatisticList.DEATHS);
         this.a(StatisticList.CUSTOM.b(StatisticList.TIME_SINCE_DEATH));
         this.a(StatisticList.CUSTOM.b(StatisticList.TIME_SINCE_REST));
-        this.extinguish();
+        this.extinguish(EntityExtinguishEvent.Reason.DEATH); // Paper
         this.setFlag(0, false);
         this.getCombatTracker().g();
     }
