From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Flo0 <flo.roma@web.de>
Date: Mon, 8 Apr 2024 16:43:16 +0200
Subject: [PATCH] API for checking sent chunks


diff --git a/src/main/java/io/papermc/paper/chunk/system/RegionizedPlayerChunkLoader.java b/src/main/java/io/papermc/paper/chunk/system/RegionizedPlayerChunkLoader.java
index 1b090f1e79b996e52097afc49c1cec85936653e6..2d4e3eeab46bb9257986e32bde3fa144ed5954c3 100644
--- a/src/main/java/io/papermc/paper/chunk/system/RegionizedPlayerChunkLoader.java
+++ b/src/main/java/io/papermc/paper/chunk/system/RegionizedPlayerChunkLoader.java
@@ -1107,6 +1107,16 @@ public class RegionizedPlayerChunkLoader {
 
             // now all tickets should be removed, which is all of our external state
         }
+
+        // For external checks
+        public boolean isChunkSent(long chunkKey) {
+            return this.sentChunks.contains(chunkKey);
+        }
+
+        // For external checks
+        public java.util.Set<Long> getSentChunks() {
+            return java.util.Set.copyOf(this.sentChunks);
+        }
     }
 
     // TODO rebase into util patch
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index e77bf7f432387bdfa7f69d31b014e8cd254fd4ca..7230ecf2127b8767b404a587de19509454b11333 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -3390,6 +3390,33 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     }
     // Paper end
 
+    // Paper start - Add chunk view API
+    @Override
+    public Set<java.lang.Long> getSentChunkKeys() {
+        return this.getHandle().chunkLoader.getSentChunks();
+    }
+
+    @Override
+    public java.util.Set<org.bukkit.Chunk> getSentChunks() {
+        Set<org.bukkit.Chunk> chunks = new HashSet<>();
+        org.bukkit.World world = this.getWorld();
+        for (long chunkKey : this.getSentChunkKeys()) {
+            chunks.add(world.getChunkAt(chunkKey, false));
+        }
+        return chunks;
+    }
+
+    @Override
+    public boolean isChunkSent(org.bukkit.Chunk chunk) {
+        return this.isChunkSent(chunk.getChunkKey());
+    }
+
+    @Override
+    public boolean isChunkSent(long chunkKey) {
+        return this.getHandle().chunkLoader.isChunkSent(chunkKey);
+    }
+    // Paper end
+
     public Player.Spigot spigot()
     {
         return this.spigot;
