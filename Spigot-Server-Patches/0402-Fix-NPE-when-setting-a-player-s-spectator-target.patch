From 7ac07ac07ac07ac07ac07ac07ac07ac07ac07ac0 Mon Sep 17 00:00:00 2001
From: Caleb Bassham <caleb.bassham@gmail.com>
Date: Sat, 20 Oct 2018 13:23:37 -0500
Subject: [PATCH] Fix NPE when setting a player's spectator target


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 7ac07ac07ac0..7ac07ac07ac0 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -1380,26 +1380,27 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             newSpectatorTarget = this;
         }
 
-        if (entity1 != newSpectatorTarget) {
-            if (newSpectatorTarget == this) {
-                com.destroystokyo.paper.event.player.PlayerStopSpectatingEntityEvent playerStopSpectatingEntityEvent = new com.destroystokyo.paper.event.player.PlayerStopSpectatingEntityEvent(this.getBukkitEntity(), entity1.getBukkitEntity());
+        if (entity1 == newSpectatorTarget) return; // new spec target is the current spec target
 
-                if (!playerStopSpectatingEntityEvent.callEvent()) {
-                    return;
-                }
-            } else {
-                com.destroystokyo.paper.event.player.PlayerStartSpectatingEntityEvent playerStartSpectatingEntityEvent = new com.destroystokyo.paper.event.player.PlayerStartSpectatingEntityEvent(this.getBukkitEntity(), entity1.getBukkitEntity(), newSpectatorTarget.getBukkitEntity());
+        if (newSpectatorTarget == this) {
+            com.destroystokyo.paper.event.player.PlayerStopSpectatingEntityEvent playerStopSpectatingEntityEvent = new com.destroystokyo.paper.event.player.PlayerStopSpectatingEntityEvent(this.getBukkitEntity(), entity1.getBukkitEntity());
 
-                if (!playerStartSpectatingEntityEvent.callEvent()) {
-                    return;
-                }
+            if (!playerStopSpectatingEntityEvent.callEvent()) {
+                return;
             }
+        } else {
+            com.destroystokyo.paper.event.player.PlayerStartSpectatingEntityEvent playerStartSpectatingEntityEvent = new com.destroystokyo.paper.event.player.PlayerStartSpectatingEntityEvent(this.getBukkitEntity(), entity1.getBukkitEntity(), newSpectatorTarget.getBukkitEntity());
 
-            this.playerConnection.sendPacket(new PacketPlayOutCamera(this.cv));
-            this.playerConnection.a(this.cv.locX, this.cv.locY, this.cv.locZ, this.yaw, this.pitch, TeleportCause.SPECTATE); // CraftBukkit
+            if (!playerStartSpectatingEntityEvent.callEvent()) {
+                return;
+            }
         }
 
         setSpectatorTargetField(newSpectatorTarget);
+
+        this.playerConnection.sendPacket(new PacketPlayOutCamera(newSpectatorTarget));
+        this.playerConnection.a(this.cv.locX, this.cv.locY, this.cv.locZ, this.yaw, this.pitch, TeleportCause.SPECTATE); // CraftBukkit
+
     }
 
     protected void E() {
-- 
2.19.1

