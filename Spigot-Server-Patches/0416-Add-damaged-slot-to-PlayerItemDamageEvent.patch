From 4a674ff0f17aa78f948dd84964594ff53722b454 Mon Sep 17 00:00:00 2001
From: MTM123 <matiss234@gmail.com>
Date: Mon, 4 Feb 2019 23:06:32 +0200
Subject: [PATCH] Add damaged slot to PlayerItemDamageEvent


diff --git a/src/main/java/net/minecraft/server/ItemStack.java b/src/main/java/net/minecraft/server/ItemStack.java
index 7827f692..ba3d5394 100644
--- a/src/main/java/net/minecraft/server/ItemStack.java
+++ b/src/main/java/net/minecraft/server/ItemStack.java
@@ -395,7 +395,26 @@ public final class ItemStack {
                 i -= k;
                 // CraftBukkit start
                 if (entityplayer != null) {
-                    PlayerItemDamageEvent event = new PlayerItemDamageEvent(entityplayer.getBukkitEntity(), CraftItemStack.asCraftMirror(this), i);
+
+                    //Paper start - getting slot that was damaged
+                    int slot = -1;
+                    if (entityplayer.getItemInMainHand() == this) {
+                        slot = entityplayer.inventory.itemInHandIndex;
+                    } else if(entityplayer.getItemInOffHand() == this) {
+                        slot = 104; //Shield slot: (last armor slot + 1)
+                    } else {
+                        int w = 100; //First armor slot. Based on https://bukkit.org/threads/inventory-slots.431469/
+                        for (ItemStack armorItem : entityplayer.getArmorItems()) {
+                            if (armorItem == this){
+                                slot = w;
+                                break;
+                            }
+                            w++;
+                        }
+                    }
+
+                    PlayerItemDamageEvent event = new PlayerItemDamageEvent(entityplayer.getBukkitEntity(), CraftItemStack.asCraftMirror(this), i, slot);
+                    //Paper - end
                     event.getPlayer().getServer().getPluginManager().callEvent(event);
 
                     if (i != event.getDamage() || event.isCancelled()) {
-- 
2.19.0.windows.1

