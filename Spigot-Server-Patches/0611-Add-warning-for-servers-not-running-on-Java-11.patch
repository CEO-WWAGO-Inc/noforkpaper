From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kyle Wood <demonwav@gmail.com>
Date: Wed, 2 Dec 2020 21:58:45 -0800
Subject: [PATCH] Add warning for servers not running on Java 11


diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java
index 6ab0a51b421dc696aec292f2db955311c9cc31e3..0a1df2c374b9375db3a8e5135091d8de27c8cc65 100644
--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java
@@ -462,4 +462,9 @@ public class PaperConfig {
     private static void trackPluginScoreboards() {
         trackPluginScoreboards = getBoolean("settings.track-plugin-scoreboards", false);
     }
+
+    public static boolean java11StartupReminder;
+    private static void java11StartupReminder() {
+        java11StartupReminder = getBoolean("settings.java-11-startup-reminder", true);
+    }
 }
diff --git a/src/main/java/io/papermc/paper/util/PaperJvmChecker.java b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java
new file mode 100644
index 0000000000000000000000000000000000000000..0d04ea76bb69ce433c7ec325c244db80fc8b36f3
--- /dev/null
+++ b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java
@@ -0,0 +1,50 @@
+package io.papermc.paper.util;
+
+import org.apache.logging.log4j.LogManager;
+import org.apache.logging.log4j.Logger;
+
+import com.destroystokyo.paper.PaperConfig;
+
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+
+public class PaperJvmChecker {
+
+    private static int getJvmVersion() {
+        String javaVersion = System.getProperty("java.version");
+        final Matcher matcher = Pattern.compile("(?:1\\.)?(\\d+)").matcher(javaVersion);
+        if (!matcher.find()) {
+            LogManager.getLogger().warn("Failed to determine Java version; Could not parse: {}", javaVersion);
+            return -1;
+        }
+
+        final String version = matcher.group(1);
+        try {
+            return Integer.parseInt(version);
+        } catch (final NumberFormatException e) {
+            LogManager.getLogger().warn("Failed to determine Java version; Could not parse {} from {}", version, javaVersion, e);
+            return -1;
+        }
+    }
+
+    public static void checkJvm() {
+        if (PaperConfig.java11StartupReminder && getJvmVersion() < 11) {
+            final Logger logger = LogManager.getLogger();
+            logger.warn("************************************************************");
+            logger.warn("* WARNING - YOU ARE RUNNING AN OUTDATED VERSION OF JAVA.");
+            logger.warn("* PAPER WILL STOP BEING COMPATIBLE WITH THIS VERSION OF");
+            logger.warn("* JAVA WHEN MINECRAFT 1.17 IS RELEASED.");
+            logger.warn("*");
+            logger.warn("* Please update the version of Java you use to run Paper");
+            logger.warn("* to at least Java 11. When Paper for Minecraft 1.17 is");
+            logger.warn("* released support for versions of Java before 11 will");
+            logger.warn("* be dropped.");
+            logger.warn("*");
+            logger.warn("* Current Java version: {}", System.getProperty("java.version"));
+            logger.warn("*");
+            logger.warn("* Check this forum post for more information: ");
+            logger.warn("*   https://papermc.io/java11");
+            logger.warn("************************************************************");
+        }
+    }
+}
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 0108a1a68572df562349688e93f8134cb14d6116..172fc9ef9c0d3444eb99f750a17d42f130d94f73 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -69,6 +69,7 @@ import org.bukkit.craftbukkit.Main;
 import org.bukkit.event.server.ServerLoadEvent;
 // CraftBukkit end
 import co.aikar.timings.MinecraftTimings; // Paper
+import io.papermc.paper.util.PaperJvmChecker; // Paper
 import org.spigotmc.SlackActivityAccountant; // Spigot
 
 public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTask> implements IMojangStatistics, ICommandListener, AutoCloseable {
@@ -950,6 +951,7 @@ public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTas
                 LOGGER.info("Done ({})! For help, type \"help\"", doneTime);
                 // Paper end
 
+                PaperJvmChecker.checkJvm(); // Paper jvm version nag
                 org.spigotmc.WatchdogThread.tick(); // Paper
                 org.spigotmc.WatchdogThread.hasStarted = true; // Paper
                 Arrays.fill( recentTps, 20 );
