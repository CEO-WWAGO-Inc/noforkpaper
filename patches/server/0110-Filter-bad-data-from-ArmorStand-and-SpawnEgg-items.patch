From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Zach Brown <zach.brown@destroystokyo.com>
Date: Sat, 12 Nov 2016 23:25:22 -0600
Subject: [PATCH] Filter bad data from ArmorStand and SpawnEgg items

Co-authored-by: Owen1212055 <23108066+Owen1212055@users.noreply.github.com>


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 80345730b8ccc11d3d0833485d25b03f614aeee2..6eb3678177834a4b34b78ba8e359528de7c0d2f0 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -352,4 +352,12 @@ public class PaperWorldConfig {
     private void removeCorruptTEs() {
         removeCorruptTEs = getBoolean("remove-corrupt-tile-entities", false);
     }
+
+    public boolean filterNBTFromSpawnEgg = true;
+    private void fitlerNBTFromSpawnEgg() {
+        filterNBTFromSpawnEgg = getBoolean("filter-nbt-data-from-spawn-eggs-and-related", true);
+        if (!filterNBTFromSpawnEgg) {
+            Bukkit.getLogger().warning("Spawn Egg and Armor Stand NBT filtering disabled, this is a potential security risk");
+        }
+    }
 }
diff --git a/src/main/java/net/minecraft/world/entity/EntityType.java b/src/main/java/net/minecraft/world/entity/EntityType.java
index 20cfdba68c200e87d00995a6a4e25a5fa8171f6c..719be4237fb260d0193b49a7f5fd60cbc10fbb0a 100644
--- a/src/main/java/net/minecraft/world/entity/EntityType.java
+++ b/src/main/java/net/minecraft/world/entity/EntityType.java
@@ -401,6 +401,7 @@ public class EntityType<T extends Entity> implements EntityTypeTest<Entity, T> {
                     CompoundTag nbttagcompound1 = entity.saveWithoutId(new CompoundTag());
                     UUID uuid = entity.getUUID();
 
+                    if (world.paperConfig.filterNBTFromSpawnEgg) { filterBadNbt(itemNbt.getCompound("EntityTag")); }
                     nbttagcompound1.merge(itemNbt.getCompound("EntityTag"));
                     entity.setUUID(uuid);
                     entity.load(nbttagcompound1);
@@ -408,6 +409,16 @@ public class EntityType<T extends Entity> implements EntityTypeTest<Entity, T> {
             }
         }
     }
+    // Paper start - Filter bad NBT
+    private static void filterBadNbt(CompoundTag tag) {
+        tag.remove("Pos");
+        tag.remove("Motion");
+        tag.remove("Rotation");
+        tag.remove("SleepingX");
+        tag.remove("SleepingY");
+        tag.remove("SleepingZ");
+    }
+    // Paper end - Filter bad NBT
 
     public boolean canSerialize() {
         return this.serialize;
diff --git a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
index 0366303a986ae6da8e95ed3051610c432a790194..7b4a1adbf093df869d0a5654e1cd7501ae9f2bc4 100644
--- a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
+++ b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
@@ -337,7 +337,7 @@ public class FallingBlockEntity extends Entity {
             this.dropItem = nbt.getBoolean("DropItem");
         }
 
-        if (nbt.contains("TileEntityData", 10)) {
+        if (nbt.contains("TileEntityData", 10) && !(this.level.paperConfig.filterNBTFromSpawnEgg && this.blockState.getBlock() instanceof net.minecraft.world.level.block.GameMasterBlock)) { // Paper - Filter bad NBT
             this.blockData = nbt.getCompound("TileEntityData");
         }
 
