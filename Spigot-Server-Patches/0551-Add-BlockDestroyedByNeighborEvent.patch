From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tom <cryptite@gmail.com>
Date: Sun, 9 Aug 2020 09:12:26 -0500
Subject: [PATCH] Add BlockDestroyedByNeighborEvent


diff --git a/src/main/java/net/minecraft/server/BlockBase.java b/src/main/java/net/minecraft/server/BlockBase.java
index 1c06647fb6f8e757ca7a737a371cb1dec2aeb80e..1e849465e8d6c091be8a404cba83dcc9e78e34a3 100644
--- a/src/main/java/net/minecraft/server/BlockBase.java
+++ b/src/main/java/net/minecraft/server/BlockBase.java
@@ -525,6 +525,18 @@ public abstract class BlockBase {
 
                 blockposition_mutableblockposition.a((BaseBlockPosition) blockposition, enumdirection);
                 IBlockData iblockdata = generatoraccess.getType(blockposition_mutableblockposition);
+
+                // Paper start - Propagate the pendingPlayerBlockEvents
+                World world = generatoraccess.getMinecraftWorld();
+                if (getBlock().getBlockData().isAir() && !iblockdata.canPlace(generatoraccess, blockposition_mutableblockposition)) {
+                    World.PendingBlockEvent blockEvent = world.pendingPlayerBlockEvents.get(blockposition);
+                    if (blockEvent != null) {
+                        blockEvent.block = blockposition_mutableblockposition.immutableCopy();
+                        blockEvent.sourceBlock = blockposition;
+                    }
+                }
+                // Paper end
+
                 IBlockData iblockdata1 = iblockdata.updateState(enumdirection.opposite(), this.p(), generatoraccess, blockposition_mutableblockposition, blockposition);
 
                 Block.a(iblockdata, iblockdata1, generatoraccess, blockposition_mutableblockposition, i, j);
diff --git a/src/main/java/net/minecraft/server/BlockTallPlant.java b/src/main/java/net/minecraft/server/BlockTallPlant.java
index 2c8d49501664862559ed8974b4821bdd36fabebf..7b0de833991dbc14ace3fbfe62a91c9744115758 100644
--- a/src/main/java/net/minecraft/server/BlockTallPlant.java
+++ b/src/main/java/net/minecraft/server/BlockTallPlant.java
@@ -1,5 +1,8 @@
 package net.minecraft.server;
 
+import org.bukkit.craftbukkit.block.CraftBlock; // Paper
+import org.bukkit.event.block.BlockDestroyedByNeighborEvent; // Paper
+
 import javax.annotation.Nullable;
 
 public class BlockTallPlant extends BlockPlant {
@@ -77,6 +80,19 @@ public class BlockTallPlant extends BlockPlant {
             BlockPosition blockposition1 = blockposition.down();
             IBlockData iblockdata1 = world.getType(blockposition1);
 
+            // Paper start
+            World.PendingBlockEvent blockEvent = world.pendingPlayerBlockEvents.remove(blockposition);
+            if (blockEvent != null) {
+                org.bukkit.block.Block blockAt = world.getWorld().getBlockAt(blockposition1.getX(), blockposition1.getY(), blockposition1.getZ());
+                BlockDestroyedByNeighborEvent breakByBlockEvent = new BlockDestroyedByNeighborEvent(blockAt, blockEvent.player, CraftBlock.at(world, blockposition));
+                world.getServer().getPluginManager().callEvent(breakByBlockEvent);
+
+                if (breakByBlockEvent.isCancelled()) {
+                    return;
+                }
+            }
+            // Paper end
+
             if (iblockdata1.getBlock() == iblockdata.getBlock() && iblockdata1.get(BlockTallPlant.HALF) == BlockPropertyDoubleBlockHalf.LOWER) {
                 world.setTypeAndData(blockposition1, Blocks.AIR.getBlockData(), 35);
                 world.a(entityhuman, 2001, blockposition1, Block.getCombinedId(iblockdata1));
diff --git a/src/main/java/net/minecraft/server/ItemStack.java b/src/main/java/net/minecraft/server/ItemStack.java
index ace50805bfebbf4c3485ba1de334d975830a7d3c..3252d6dad509692c40a93cf35279cea67eed96fc 100644
--- a/src/main/java/net/minecraft/server/ItemStack.java
+++ b/src/main/java/net/minecraft/server/ItemStack.java
@@ -231,6 +231,9 @@ public final class ItemStack {
                 }
             }
             Item item = this.getItem();
+
+            world.pendingPlayerBlockEvents.put(blockposition, new World.PendingBlockEvent(blockposition, (Player) entityhuman.getBukkitEntity())); // Paper
+
             EnumInteractionResult enuminteractionresult = item.a(itemactioncontext);
             NBTTagCompound newData = this.getTagClone();
             int newCount = this.getCount();
diff --git a/src/main/java/net/minecraft/server/PlayerInteractManager.java b/src/main/java/net/minecraft/server/PlayerInteractManager.java
index 4b564d36135e9dbdbb57a95791f89aefd180457b..63894f58d64d169697075abb172f1464255281da 100644
--- a/src/main/java/net/minecraft/server/PlayerInteractManager.java
+++ b/src/main/java/net/minecraft/server/PlayerInteractManager.java
@@ -363,6 +363,9 @@ public class PlayerInteractManager {
                 org.bukkit.block.BlockState state = bblock.getState();
                 world.captureDrops = new ArrayList<>();
                 // CraftBukkit end
+
+                world.pendingPlayerBlockEvents.put(blockposition, new World.PendingBlockEvent(blockposition, this.player.getBukkitEntity())); // Paper
+
                 block.a((World) this.world, blockposition, iblockdata, (EntityHuman) this.player);
                 boolean flag = this.world.a(blockposition, false);
 
@@ -390,6 +393,8 @@ public class PlayerInteractManager {
                 }
                 world.captureDrops = null;
 
+                world.pendingPlayerBlockEvents.remove(blockposition); // Paper
+
                 // Drop event experience
                 if (flag && event != null) {
                     iblockdata.getBlock().dropExperience(this.world, blockposition, event.getExpToDrop(), this.player); // Paper
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index fb3776c00cf8b5125550e8a2bc6c270ba8a80dc5..3e1b5b35d8e4693fb9ce90c56e3011fbc38d17b5 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -28,8 +28,11 @@ import org.bukkit.Bukkit;
 import org.bukkit.craftbukkit.CraftServer;
 import org.bukkit.craftbukkit.CraftWorld;
 import org.bukkit.craftbukkit.block.CapturedBlockState;
+import org.bukkit.craftbukkit.block.CraftBlock;
 import org.bukkit.craftbukkit.block.CraftBlockState;
 import org.bukkit.craftbukkit.block.data.CraftBlockData;
+import org.bukkit.entity.Player;
+import org.bukkit.event.block.BlockDestroyedByNeighborEvent;
 import org.bukkit.event.block.BlockPhysicsEvent;
 // CraftBukkit end
 
@@ -102,6 +105,28 @@ public abstract class World implements GeneratorAccess, AutoCloseable {
     public final Map<Explosion.CacheKey, Float> explosionDensityCache = new HashMap<>(); // Paper - Optimize explosions
     public java.util.ArrayDeque<BlockRedstoneTorch.RedstoneUpdateInfo> redstoneUpdateInfos; // Paper - Move from Map in BlockRedstoneTorch to here
 
+    // Paper start - Abstract holder class that can be used to track what Player did the last "block thing"
+    public static class PendingBlockEvent {
+
+        public BlockPosition block;
+        public final Player player;
+        public BlockPosition sourceBlock;
+
+        public PendingBlockEvent(BlockPosition block, Player player) {
+            this.block = block;
+            this.player = player;
+        }
+
+        public PendingBlockEvent(BlockPosition block, Player player, BlockPosition sourceBlock) {
+            this.block = block;
+            this.player = player;
+            this.sourceBlock = sourceBlock;
+        }
+
+    }
+    public final Map<BlockPosition, PendingBlockEvent> pendingPlayerBlockEvents = new HashMap<>();
+    // Paper end
+
     public CraftWorld getWorld() {
         return this.world;
     }
@@ -504,6 +529,8 @@ public abstract class World implements GeneratorAccess, AutoCloseable {
             }
 
             this.a(blockposition, iblockdata1, iblockdata2);
+
+            pendingPlayerBlockEvents.remove(blockposition); //Paper
         }
     }
     // CraftBukkit end
@@ -525,6 +552,14 @@ public abstract class World implements GeneratorAccess, AutoCloseable {
         if (iblockdata.isAir()) {
             return false;
         } else {
+            // Paper start
+            PendingBlockEvent blockEvent = pendingPlayerBlockEvents.get(blockposition);
+            if (blockEvent != null && blockEvent.sourceBlock != null) {
+                BlockDestroyedByNeighborEvent breakByBlockEvent = new BlockDestroyedByNeighborEvent(CraftBlock.at(this, blockposition), blockEvent.player, CraftBlock.at(this, blockEvent.sourceBlock));
+                getServer().getPluginManager().callEvent(breakByBlockEvent);
+            }
+            // Paper end
+
             Fluid fluid = this.getFluid(blockposition);
             // Paper start - while the above setAir method is named same and looks very similar
             // they are NOT used with same intent and the above should not fire this event. The above method is more of a BlockSetToAirEvent,
@@ -601,8 +636,23 @@ public abstract class World implements GeneratorAccess, AutoCloseable {
     public void a(BlockPosition blockposition, Block block, BlockPosition blockposition1) {
         if (!this.isClientSide) {
             IBlockData iblockdata = this.getType(blockposition);
+            org.bukkit.block.Block blockAt = world.getBlockAt(blockposition.getX(), blockposition.getY(), blockposition.getZ()); // Paper
 
             try {
+                // Paper start
+                if (!blockAt.getType().isAir() && iblockdata.getMaterial() == Material.AIR) {
+                    PendingBlockEvent blockEvent = pendingPlayerBlockEvents.remove(blockposition);
+                    if (blockEvent != null) {
+                        BlockDestroyedByNeighborEvent breakByBlockEvent = new BlockDestroyedByNeighborEvent(blockAt, blockEvent.player, CraftBlock.at(this, blockposition));
+                        getServer().getPluginManager().callEvent(breakByBlockEvent);
+
+                        if (breakByBlockEvent.isCancelled()) {
+                            return;
+                        }
+                    }
+                }
+                // Paper end
+
                 // CraftBukkit start
                 CraftWorld world = ((WorldServer) this).getWorld();
                 if (world != null && ((WorldServer)this).hasPhysicsEvent) { // Paper
