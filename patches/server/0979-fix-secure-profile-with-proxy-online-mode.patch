From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: NonSwag <mrminecraft00@gmail.com>
Date: Thu, 4 May 2023 19:41:02 +0200
Subject: [PATCH] fix secure profile with proxy online mode


diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index a7e133f3495e9132a5fdae2c24f225e7b026295a..7ff6741166fdcc1ad912ebabc893d4fb0a1b2035 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -637,7 +637,12 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
 
     @Override
     public boolean enforceSecureProfile() {
-        return this.getProperties().enforceSecureProfile && this.getProperties().onlineMode;
+        // Paper start - fix secure profile with proxy online mode
+        var globalConfiguration = io.papermc.paper.configuration.GlobalConfiguration.get();
+        return this.getProperties().enforceSecureProfile && this.getProperties().onlineMode
+            || (org.spigotmc.SpigotConfig.bungee && globalConfiguration.proxies.bungeeCord.onlineMode)
+            || (globalConfiguration.proxies.velocity.enabled && globalConfiguration.proxies.velocity.onlineMode);
+        // Paper end
     }
 
     protected boolean convertOldUsers() {
