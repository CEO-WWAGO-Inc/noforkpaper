From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: GioSDA <gsdambrosio@gmail.com>
Date: Wed, 10 Mar 2021 10:06:45 -0800
Subject: [PATCH] Item Merge Through Walls Fix


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index fd675585c61387156892b179af593ad640873d45..9189fa7a5015ff6a272318a141507b48279bd9c4 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -815,4 +815,9 @@ public class PaperWorldConfig {
     private void allowUsingSignsInsideSpawnProtection() {
         allowUsingSignsInsideSpawnProtection = getBoolean("allow-using-signs-inside-spawn-protection", allowUsingSignsInsideSpawnProtection);
     }
+
+    public boolean mergeItemsThroughWalls = false;
+    private void mergeItemsThroughWalls() {
+        mergeItemsThroughWalls = getBoolean("merge-items-through-walls", mergeItemsThroughWalls);
+    }
 }
diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 5dfb54e17fcfe6bd30e6b2a449944606e1a0ef17..5f771055a91bb0806227477c4d27ad5886d19147 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -202,6 +202,15 @@ public class EntityItem extends Entity {
                 EntityItem entityitem = (EntityItem) iterator.next();
 
                 if (entityitem.z()) {
+                    // Paper Start - Fix item merging through walls
+                    if (!this.world.paperConfig.mergeItemsThroughWalls) {
+                        RayTrace rayTrace = new RayTrace(this.getPositionVector(), entityitem.getPositionVector(), RayTrace.BlockCollisionOption.COLLIDER, RayTrace.FluidCollisionOption.NONE, this);
+                        MovingObjectPositionBlock rayTraceResult = world.rayTrace(rayTrace);
+
+                        if (rayTraceResult.getType() == MovingObjectPosition.EnumMovingObjectType.BLOCK) continue;
+                    }
+                    // Paper End
+
                     this.a(entityitem);
                     if (this.dead) {
                         break;
